<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI é‹¼ç´éˆæ„Ÿç”¢ç”Ÿå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Tone.js æ ¸å¿ƒ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- æ–°å¢ï¼šå¼•å…¥ abcjs ç”¨æ–¼åœ¨é é¢å…§æ¸²æŸ“æ¨‚è­œ -->
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.0/dist/abcjs-basic-min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans TC", sans-serif;
      }
      #svg-container {
        overflow: auto;
        border: 1px solid #e5e7eb;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 250px;
        background-color: #f9fafb;
        user-select: none;
        touch-action: none;
      }
      #piano-svg {
        width: 100%;
        transition: transform 0.2s ease-in-out;
        transform-origin: center;
      }
      #piano-svg rect:active,
      #piano-svg rect.playing {
        fill: #9ca3af !important;
      }
      #piano-svg.loading {
        opacity: 0.5;
        pointer-events: none;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-50 flex flex-col items-center justify-center min-h-screen p-4 sm:p-6"
  >
    <div class="w-full max-w-6xl bg-white p-5 sm:p-8 rounded-2xl shadow-lg">
      <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-2">
        AI é‹¼ç´éˆæ„Ÿç”¢ç”Ÿå™¨
      </h1>
      <p class="text-center text-gray-500 mb-6">
        ä¸€å€‹ç”± Gemini API é©…å‹•çš„å‰µæ„éŸ³æ¨‚å·¥å…·
      </p>

      <div class="mb-8">
        <div class="flex items-center justify-center mb-4">
          <h2 class="text-xl font-semibold text-gray-700">äº’å‹•å¼é‹¼ç´ ğŸ”Š</h2>
          <span id="loading-status" class="ml-4 text-sm text-blue-500"></span>
        </div>
        <div class="flex items-center justify-center space-x-4 mb-4">
          <button
            id="zoom-out"
            class="px-5 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors"
          >
            ç¸®å° (-)
          </button>
          <span
            id="zoom-level"
            class="text-lg text-gray-600 font-medium w-36 text-center"
          ></span>
          <button
            id="zoom-in"
            class="px-5 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors"
          >
            æ”¾å¤§ (+)
          </button>
        </div>

        <div id="svg-container" class="w-full bg-white rounded-lg p-4">
          <svg
            id="piano-svg"
            class="loading"
            viewBox="0 0 1197 120"
            xmlns="http://www.w3.org/2000/svg"
            version="1.1"
          >
            <desc>äº’å‹•å¼ 88 éµé‹¼ç´éµç›¤</desc>
            <style>
              #white-keys rect:hover {
                fill: #e0e0e0;
                cursor: pointer;
              }
              #black-keys rect:hover {
                fill: #333333;
                cursor: pointer;
              }
            </style>
            <g id="white-keys">
              <rect
                data-note="A0"
                x="0"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B0"
                x="23"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C1"
                x="46"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D1"
                x="69"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E1"
                x="92"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F1"
                x="115"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G1"
                x="138"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A1"
                x="161"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B1"
                x="184"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C2"
                x="207"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D2"
                x="230"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E2"
                x="253"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F2"
                x="276"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G2"
                x="299"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A2"
                x="322"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B2"
                x="345"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C3"
                x="368"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D3"
                x="391"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E3"
                x="414"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F3"
                x="437"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G3"
                x="460"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A3"
                x="483"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B3"
                x="506"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C4"
                x="529"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D4"
                x="552"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E4"
                x="575"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F4"
                x="598"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G4"
                x="621"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A4"
                x="644"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B4"
                x="667"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C5"
                x="690"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D5"
                x="713"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E5"
                x="736"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F5"
                x="759"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G5"
                x="782"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A5"
                x="805"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B5"
                x="828"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C6"
                x="851"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D6"
                x="874"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E6"
                x="897"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F6"
                x="920"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G6"
                x="943"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A6"
                x="966"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B6"
                x="989"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C7"
                x="1012"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D7"
                x="1035"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E7"
                x="1058"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F7"
                x="1081"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G7"
                x="1104"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A7"
                x="1127"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B7"
                x="1150"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C8"
                x="1173"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
            </g>
            <g id="black-keys">
              <rect
                data-note="A#0"
                x="16.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#1"
                x="62.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#1"
                x="85.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#1"
                x="131.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#1"
                x="154.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#1"
                x="177.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#2"
                x="223.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#2"
                x="246.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#2"
                x="292.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#2"
                x="315.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#2"
                x="338.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#3"
                x="384.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#3"
                x="407.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#3"
                x="453.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#3"
                x="476.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#3"
                x="499.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#4"
                x="545.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#4"
                x="568.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#4"
                x="614.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#4"
                x="637.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#4"
                x="660.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#5"
                x="706.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#5"
                x="729.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#5"
                x="775.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#5"
                x="798.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#5"
                x="821.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#6"
                x="867.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#6"
                x="890.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#6"
                x="936.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#6"
                x="959.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#6"
                x="982.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#7"
                x="1028.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#7"
                x="1051.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#7"
                x="1097.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#7"
                x="1120.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#7"
                x="1143.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
            </g>
          </svg>
        </div>
      </div>

      <div class="border-t border-gray-200 pt-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">
          âœ¨ ç”¢ç”Ÿæ—‹å¾‹éˆæ„Ÿ
        </h2>
        <div class="max-w-2xl mx-auto">
          <div
            class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg"
          >
            <div id="api-key-display-view" class="hidden">
              <div class="flex justify-between items-center">
                <p class="text-sm font-medium text-green-800">
                  âœ“ API é‡‘é‘°å·²è¨­å®š
                </p>
                <button
                  id="clear-key-btn"
                  class="px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-colors"
                >
                  æ¸…é™¤é‡‘é‘°
                </button>
              </div>
            </div>
            <div id="api-key-setup-view">
              <label
                for="api-key-input"
                class="block text-sm font-medium text-gray-700 mb-2"
                >æ‚¨çš„ Gemini API é‡‘é‘°</label
              >
              <div class="flex gap-2">
                <input
                  type="password"
                  id="api-key-input"
                  placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API é‡‘é‘°"
                  class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none transition"
                />
                <button
                  id="save-key-btn"
                  class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-sm hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-colors"
                >
                  å„²å­˜
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-2">
                æ‚¨çš„é‡‘é‘°åªæœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³ã€‚
                <a
                  href="https://aistudio.google.com/"
                  target="_blank"
                  class="text-blue-600 hover:underline"
                  >é»æ­¤å…è²»å–å¾—é‡‘é‘°</a
                >
              </p>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-4">
            <input
              type="text"
              id="prompt-input"
              placeholder="è¼¸å…¥ä¸€å€‹ä¸»é¡Œï¼Œä¾‹å¦‚ï¼šæ˜Ÿç©ºä¸‹çš„ç‡Ÿç«"
              class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none transition"
            />
            <button
              id="generate-btn"
              class="w-full sm:w-auto px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition-colors flex items-center justify-center"
            >
              ç”¢ç”Ÿéˆæ„Ÿ
            </button>
          </div>
          <div
            id="result-container"
            class="mt-6 p-5 bg-gray-50 border border-gray-200 rounded-lg min-h-[100px] whitespace-pre-wrap"
          >
            <p id="result-text" class="text-gray-600">
              AI ç”¢ç”Ÿçš„éˆæ„Ÿå°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡...
            </p>
            <div id="loader" class="hidden mx-auto loader"></div>
          </div>
          <!-- æ’­æ”¾æ§åˆ¶å€å¡Š -->
          <div
            id="playback-controls"
            class="hidden mt-4 flex justify-center items-center gap-4 p-4 bg-gray-100 rounded-lg"
          >
            <button
              id="play-pause-btn"
              class="px-5 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 transition-colors"
            >
              æ’­æ”¾
            </button>
            <button
              id="stop-btn"
              class="px-5 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-sm hover:bg-gray-600 transition-colors"
            >
              åœæ­¢
            </button>
          </div>
          <!-- æ¨‚è­œä¸‹è¼‰èˆ‡é è¦½å€å¡Š -->
          <div
            id="sheet-music-container"
            class="hidden mt-4 p-4 bg-gray-100 rounded-lg"
          >
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-semibold text-gray-700">éŸ³æ¨‚æ¨‚è­œ</h3>
              <button
                id="download-abc-btn"
                class="px-4 py-2 bg-indigo-500 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-indigo-600 transition-colors"
              >
                ä¸‹è¼‰ .abc
              </button>
            </div>
            <!-- å…§åµŒæ¨‚è­œé è¦½çš„å®¹å™¨ -->
            <div
              id="abc-score-preview"
              class="w-full bg-white p-2 rounded border border-gray-200 overflow-x-auto"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š ---
      const svgElement = document.getElementById("piano-svg");
      // ä¿®æ­£ï¼šåŠ å…¥ Compressor å’Œ Limiter ä¾†é˜²æ­¢çˆ†éŸ³ï¼Œä¸¦èª¿æ•´éŸ³é‡
      const compressor = new Tone.Compressor(-30, 3);
      const limiter = new Tone.Limiter(-6);
      const masterVolume = new Tone.Volume(-12); // é™ä½æ•´é«”éŸ³é‡

      // å»ºç«‹éŸ³æ•ˆéˆï¼šsampler -> compressor -> volume -> limiter -> destination
      compressor.connect(masterVolume);
      masterVolume.connect(limiter);
      limiter.toDestination();

      const sampler = new Tone.Sampler({
        urls: {
          A0: "A0.mp3",
          C1: "C1.mp3",
          "D#1": "Ds1.mp3",
          "F#1": "Fs1.mp3",
          A1: "A1.mp3",
          C2: "C2.mp3",
          "D#2": "Ds2.mp3",
          "F#2": "Fs2.mp3",
          A2: "A2.mp3",
          C3: "C3.mp3",
          "D#3": "Ds3.mp3",
          "F#3": "Fs3.mp3",
          A3: "A3.mp3",
          C4: "C4.mp3",
          "D#4": "Ds4.mp3",
          "F#4": "Fs4.mp3",
          A4: "A4.mp3",
          C5: "C5.mp3",
          "D#5": "Ds5.mp3",
          "F#5": "Fs5.mp3",
          A5: "A5.mp3",
          C6: "C6.mp3",
          "D#6": "Ds6.mp3",
          "F#6": "Fs6.mp3",
          A6: "A6.mp3",
          C7: "C7.mp3",
          "D#7": "Ds7.mp3",
          "F#7": "Fs7.mp3",
          A7: "A7.mp3",
          C8: "C8.mp3",
        },
        release: 1,
        attack: 0.005, // åŠ å¿«éŸ³ç¬¦èµ·éŸ³
        baseUrl: "https://tonejs.github.io/audio/salamander/",
        onload: () => {
          document.getElementById("loading-status").textContent = "";
          svgElement.classList.remove("loading");
        },
      }).connect(compressor); // å°‡ sampler é€£æ¥åˆ° compressor
      let currentPart = null;

      // --- ç¸®æ”¾åŠŸèƒ½ ---
      const zoomInBtn = document.getElementById("zoom-in");
      const zoomOutBtn = document.getElementById("zoom-out");
      const zoomLevelDisplay = document.getElementById("zoom-level");
      let currentScale = 1.0;
      const zoomStep = 0.1;
      function updateZoom() {
        svgElement.style.transform = `scale(${currentScale})`;
        zoomLevelDisplay.textContent = `ç›®å‰ç¸®æ”¾ï¼š${Math.round(
          currentScale * 100
        )}%`;
      }
      zoomInBtn.addEventListener("click", () => {
        currentScale += zoomStep;
        updateZoom();
      });
      zoomOutBtn.addEventListener("click", () => {
        if (currentScale > 0.2) {
          currentScale -= zoomStep;
          updateZoom();
        }
      });
      updateZoom();

      // --- æ‰‹å‹•å½ˆå¥åŠŸèƒ½ ---
      const pianoContainer = document.getElementById("svg-container");
      let isMouseDown = false;
      const lastActiveElement = new Map();
      function playNoteFromElement(element, identifier = "mouse") {
        if (lastActiveElement.get(identifier) === element) return;
        if (Tone.context.state !== "running") Tone.context.resume();
        const note = element.dataset.note;
        if (note && sampler.loaded) {
          sampler.triggerAttack(note, Tone.now());
          lastActiveElement.set(identifier, element);
        }
      }
      function releaseAllNotes() {
        lastActiveElement.clear();
        sampler.releaseAll();
      }
      pianoContainer.addEventListener("mousedown", (e) => {
        if (e.target.matches("#piano-svg rect")) {
          isMouseDown = true;
          playNoteFromElement(e.target, "mouse");
        }
      });
      pianoContainer.addEventListener("mouseover", (e) => {
        if (isMouseDown && e.target.matches("#piano-svg rect")) {
          playNoteFromElement(e.target, "mouse");
        }
      });
      document.body.addEventListener("mouseup", () => {
        isMouseDown = false;
        releaseAllNotes();
      });
      document.body.addEventListener("mouseleave", () => {
        if (isMouseDown) {
          isMouseDown = false;
          releaseAllNotes();
        }
      });
      function handleTouch(event) {
        event.preventDefault();
        for (const touch of event.changedTouches) {
          const element = document.elementFromPoint(
            touch.clientX,
            touch.clientY
          );
          if (element && element.matches("#piano-svg rect")) {
            playNoteFromElement(element, touch.identifier);
          }
        }
      }
      pianoContainer.addEventListener("touchstart", handleTouch, {
        passive: false,
      });
      pianoContainer.addEventListener("touchmove", handleTouch, {
        passive: false,
      });
      pianoContainer.addEventListener("touchend", releaseAllNotes);
      pianoContainer.addEventListener("touchcancel", releaseAllNotes);

      // --- è‡ªå‹•æ¼”å¥åŠŸèƒ½ ---
      const playbackControls = document.getElementById("playback-controls");
      const playPauseBtn = document.getElementById("play-pause-btn");
      const stopBtn = document.getElementById("stop-btn");
      const sheetMusicContainer = document.getElementById(
        "sheet-music-container"
      );
      const downloadAbcBtn = document.getElementById("download-abc-btn");
      const abcScorePreview = document.getElementById("abc-score-preview");

      function setupPlayback(sequence, abcString) {
        if (!sequence || !sampler.loaded) return;

        // ç¢ºä¿éŸ³è¨Š context å·²å•Ÿå‹•
        if (Tone.context.state !== "running") {
          Tone.context.resume();
        }

        // å®Œå…¨æ¸…ç†ä¹‹å‰çš„è¨­å®š
        Tone.Transport.stop();
        Tone.Transport.cancel();
        Tone.Transport.position = 0;

        // æ¸…é™¤æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
        Tone.Transport.off("stop");

        // å¾ABCè¨˜è­œæ³•ä¸­è§£ætempoï¼ˆå¦‚æœå­˜åœ¨çš„è©±ï¼‰
        let finalTempo = sequence.tempo || 100;
        const tempoMatch = abcString.match(/Q:1\/4=(\d+)/);
        if (tempoMatch) {
          finalTempo = parseInt(tempoMatch[1]);
          console.log(`å¾ABCè­œè§£æåˆ°tempo: ${finalTempo}`);
        }

        // è¨­å®š tempo - ç¢ºä¿åœ¨å‰µå»º Part ä¹‹å‰è¨­å®š
        Tone.Transport.bpm.value = finalTempo;
        console.log(`æœ€çµ‚è¨­å®š tempo: ${Tone.Transport.bpm.value} BPM`);

        if (currentPart) {
          currentPart.dispose();
          currentPart = null;
        }

        // æ’åºéŸ³ç¬¦ä»¥ç¢ºä¿æ™‚é–“é †åºæ­£ç¢º
        const sortedNotes = sequence.notes.sort(
          (a, b) =>
            Tone.Time(a.time).toSeconds() - Tone.Time(b.time).toSeconds()
        );

        currentPart = new Tone.Part((time, value) => {
          // ä¿®æ­£ï¼šé™åˆ¶ velocity ç¯„åœï¼Œé¿å…çˆ†éŸ³
          const normalizedVelocity = Math.min(
            Math.max(value.velocity || 0.7, 0.1),
            0.8
          );

          if (Array.isArray(value.note)) {
            // è™•ç†å’Œå¼¦ï¼šåŒæ™‚æ’­æ”¾å¤šå€‹éŸ³ç¬¦
            console.log(`æ’­æ”¾å’Œå¼¦: ${value.note.join(", ")} at ${value.time}`);
            value.note.forEach((note) => {
              sampler.triggerAttackRelease(
                note,
                value.duration,
                time,
                normalizedVelocity
              );
            });

            // è¦–è¦ºåŒ–å’Œå¼¦ä¸­çš„æ‰€æœ‰éŸ³ç¬¦
            Tone.Draw.schedule(() => {
              value.note.forEach((note) => {
                const keyElement = document.querySelector(
                  `[data-note="${note}"]`
                );
                if (keyElement) {
                  keyElement.classList.add("playing");
                  setTimeout(
                    () => keyElement.classList.remove("playing"),
                    Tone.Time(value.duration).toMilliseconds()
                  );
                }
              });
            }, time);
          } else {
            // è™•ç†å–®éŸ³
            console.log(`æ’­æ”¾å–®éŸ³: ${value.note} at ${value.time}`);
            sampler.triggerAttackRelease(
              value.note,
              value.duration,
              time,
              normalizedVelocity
            );

            Tone.Draw.schedule(() => {
              const keyElement = document.querySelector(
                `[data-note="${value.note}"]`
              );
              if (keyElement) {
                keyElement.classList.add("playing");
                setTimeout(
                  () => keyElement.classList.remove("playing"),
                  Tone.Time(value.duration).toMilliseconds()
                );
              }
            }, time);
          }
        }, sortedNotes);

        // è¨­å®š part é–‹å§‹æ™‚é–“
        currentPart.start(0);
        currentPart.loop = false;

        // ç›£è½ transport stop äº‹ä»¶ä¾†æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼ˆåªè¨»å†Šä¸€æ¬¡ï¼‰
        Tone.Transport.on("stop", () => {
          playPauseBtn.textContent = "æ’­æ”¾";
          console.log("æ’­æ”¾åœæ­¢ï¼ŒæŒ‰éˆ•é‡ç½®ç‚ºæ’­æ”¾");
        });

        // è¨ˆç®—ç¸½æ’­æ”¾æ™‚é–“ä¸¦è¨­å®šè‡ªå‹•åœæ­¢
        const lastNote = sortedNotes[sortedNotes.length - 1];
        if (lastNote) {
          const endTime =
            Tone.Time(lastNote.time).toSeconds() +
            Tone.Time(lastNote.duration).toSeconds() +
            0.5; // åŠ ä¸€é»ç·©è¡æ™‚é–“
          console.log(`è¨­å®šè‡ªå‹•åœæ­¢æ™‚é–“: ${endTime}ç§’`);
          Tone.Transport.scheduleOnce(() => {
            console.log("éŸ³æ¨‚æ’­æ”¾çµæŸï¼Œè‡ªå‹•åœæ­¢");
            Tone.Transport.stop();
          }, endTime);
        }

        playbackControls.classList.remove("hidden");
        sheetMusicContainer.classList.remove("hidden");
        playPauseBtn.textContent = "æ’­æ”¾";

        // æ¸²æŸ“å…§åµŒæ¨‚è­œ - è¨­å®šæ­£ç¢ºçš„é‹¼ç´è­œé¸é …
        abcScorePreview.innerHTML = ""; // æ¸…ç©ºèˆŠæ¨‚è­œ
        ABCJS.renderAbc(abcScorePreview, abcString, {
          responsive: "resize",
          staffwidth: 600,
          scale: 0.8,
          paddingright: 20,
          paddingleft: 20,
          paddingtop: 20,
          paddingbottom: 20,
          staffsep: 80, // å¢åŠ äº”ç·šè­œä¹‹é–“çš„é–“è·
          wrap: {
            minSpacing: 1.8,
            maxSpacing: 2.7,
            preferredMeasuresPerLine: 4,
          },
          format: {
            titlefont: "Times 16",
            gchordfont: "Times 12",
            annotationfont: "Times 12",
            vocalfont: "Times 12",
            wordsfont: "Times 12",
          },
        });

        downloadAbcBtn.onclick = () => {
          const blob = new Blob([abcString], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "ai-melody.abc";
          a.click();
          URL.revokeObjectURL(url);
        };
      }

      playPauseBtn.addEventListener("click", async () => {
        // ç¢ºä¿éŸ³è¨Š context å·²å•Ÿå‹•
        if (Tone.context.state !== "running") {
          await Tone.context.resume();
        }

        if (Tone.Transport.state === "started") {
          Tone.Transport.pause();
          playPauseBtn.textContent = "ç¹¼çºŒ";
        } else {
          // é‡ç½®ä½ç½®åˆ°é–‹å§‹ï¼ˆå¦‚æœæ˜¯åœæ­¢ç‹€æ…‹ï¼‰
          if (Tone.Transport.state === "stopped") {
            Tone.Transport.position = 0;
          }
          Tone.Transport.start();
          playPauseBtn.textContent = "æš«åœ";
        }
      });

      stopBtn.addEventListener("click", () => {
        Tone.Transport.stop();
        Tone.Transport.position = 0; // é‡ç½®æ’­æ”¾ä½ç½®
        playPauseBtn.textContent = "æ’­æ”¾";
      });

      // --- Gemini API åŠŸèƒ½ ---
      const generateBtn = document.getElementById("generate-btn");
      const promptInput = document.getElementById("prompt-input");
      const resultText = document.getElementById("result-text");
      const loader = document.getElementById("loader");
      const apiKeyInput = document.getElementById("api-key-input");
      const saveKeyBtn = document.getElementById("save-key-btn");
      const clearKeyBtn = document.getElementById("clear-key-btn");
      const apiKeySetupView = document.getElementById("api-key-setup-view");
      const apiKeyDisplayView = document.getElementById("api-key-display-view");

      function checkApiKey() {
        const apiKey = localStorage.getItem("geminiApiKey");
        if (apiKey) {
          apiKeySetupView.classList.add("hidden");
          apiKeyDisplayView.classList.remove("hidden");
          generateBtn.disabled = false;
          generateBtn.classList.remove("opacity-50", "cursor-not-allowed");
        } else {
          apiKeySetupView.classList.remove("hidden");
          apiKeyDisplayView.classList.add("hidden");
          generateBtn.disabled = true;
          generateBtn.classList.add("opacity-50", "cursor-not-allowed");
          resultText.textContent =
            "è«‹å…ˆåœ¨ä¸Šæ–¹è¨­å®šæ‚¨çš„ Gemini API é‡‘é‘°ä»¥å•Ÿç”¨æ­¤åŠŸèƒ½ã€‚";
        }
      }

      saveKeyBtn.addEventListener("click", () => {
        const apiKey = apiKeyInput.value.trim();
        if (apiKey) {
          localStorage.setItem("geminiApiKey", apiKey);
          alert("API é‡‘é‘°å·²å„²å­˜ï¼");
          checkApiKey();
          resultText.textContent = "å·²è¼‰å…¥æ‚¨çš„ API é‡‘é‘°ï¼Œå¯ä»¥é–‹å§‹ç”¢ç”Ÿéˆæ„Ÿäº†ï¼";
        } else {
          alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ API é‡‘é‘°ã€‚");
        }
      });

      clearKeyBtn.addEventListener("click", () => {
        localStorage.removeItem("geminiApiKey");
        alert("API é‡‘é‘°å·²æ¸…é™¤ï¼");
        checkApiKey();
      });

      promptInput.addEventListener("input", () => {
        playbackControls.classList.add("hidden");
        sheetMusicContainer.classList.add("hidden");
        Tone.Transport.stop();
      });

      async function handleGenerateClick() {
        const apiKey = localStorage.getItem("geminiApiKey");
        if (!apiKey) {
          alert("è«‹å…ˆå„²å­˜æ‚¨çš„ Gemini API é‡‘é‘°ï¼");
          return;
        }
        const userPrompt = promptInput.value.trim();
        if (!userPrompt) {
          resultText.textContent = "è«‹å…ˆè¼¸å…¥ä¸€å€‹ä¸»é¡Œæˆ–æƒ…å¢ƒï¼";
          return;
        }

        resultText.textContent = "";
        loader.classList.remove("hidden");
        generateBtn.disabled = true;
        generateBtn.classList.add("opacity-50", "cursor-not-allowed");
        playbackControls.classList.add("hidden");
        sheetMusicContainer.classList.add("hidden");

        // ä¿®æ­£ï¼šå¼·åŒ– ABC è­œçš„ promptï¼Œè¦æ±‚åŒ…å«æ­£ç¢ºçš„é‹¼ç´è­œæ ¼å¼
        const fullPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šæ¨‚ç†çš„AIä½œæ›²å®¶ã€‚æ ¹æ“šä»¥ä¸‹ä¸»é¡Œï¼Œå‰µä½œä¸€æ®µ8åˆ°16å°ç¯€ï¼Œé©åˆé‹¼ç´ç¨å¥çš„ç°¡çŸ­éŸ³æ¨‚ã€‚è«‹åŒ…å«æ—‹å¾‹å’Œå’Œå¼¦ä¼´å¥ã€‚è«‹ä»¥JSONæ ¼å¼å›å‚³ï¼ŒåŒ…å«ï¼š

1. 'tempo' (BPMé€Ÿåº¦ï¼Œå»ºè­°60-120)
2. 'melody_description' (æ—‹å¾‹æè¿°æ–‡å­—)
3. 'notes' (éŸ³ç¬¦ç‰©ä»¶é™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶åŒ…å« 'time', 'note' (å¯ä»¥æ˜¯å­—ä¸²æˆ–å­—ä¸²é™£åˆ—ï¼Œé™£åˆ—è¡¨ç¤ºå’Œå¼¦), 'duration', 'velocity' (0.1-0.8ä¹‹é–“))
4. 'abc_notation' (æ¨™æº–ABCè­œæ ¼å¼çš„å­—ä¸²ï¼Œå¿…é ˆåŒ…å«å®Œæ•´æ¨™é ­ä¸¦ä½¿ç”¨æ­£ç¢ºçš„é‹¼ç´è­œæ ¼å¼)

ABCè¨˜è­œæ³•è¦æ±‚ï¼š
- æ¨™é ­æ ¼å¼ï¼šX:1\\nT:${userPrompt}\\nM:4/4\\nL:1/4\\nK:C\\nQ:1/4=[tempo]
- ä½¿ç”¨é›™äº”ç·šè­œæ ¼å¼ï¼Œå³æ‰‹é«˜éŸ³è­œè¨˜è™Ÿï¼Œå·¦æ‰‹ä½éŸ³è­œè¨˜è™Ÿ
- å³æ‰‹éƒ¨åˆ†ï¼ˆé«˜éŸ³è­œè¨˜è™Ÿï¼‰ï¼š[V:1] éŸ³åŸŸå»ºè­°åœ¨C-c'ä¹‹é–“ï¼ˆC4-C6ï¼‰
- å·¦æ‰‹éƒ¨åˆ†ï¼ˆä½éŸ³è­œè¨˜è™Ÿï¼‰ï¼š[V:2 clef=bass] éŸ³åŸŸå»ºè­°åœ¨C,-Cä¹‹é–“ï¼ˆC2-C4ï¼‰
- å’Œå¼¦è¡¨ç¤ºæ³•ï¼šå³æ‰‹ç”¨[CEG]ï¼Œå·¦æ‰‹ç”¨[C,E,G,]ï¼ˆé€—è™Ÿè¡¨ç¤ºä½å…«åº¦ï¼‰
- å°ç¯€ç·šç”¨ | åˆ†éš”ï¼Œæ¨‚æ›²çµæŸå¿…é ˆç”¨ |] ï¼ˆé›™ç·šè¡¨ç¤ºçµæŸï¼‰
- ç¢ºä¿æ¯å€‹è²éƒ¨éƒ½æœ‰çµæŸæ¨™è¨˜
- ç¯„ä¾‹æ ¼å¼ï¼š
  [V:1] C E G c | F A c f | G E C2 |]
  [V:2 clef=bass] C, E, G, C | F, A, C F | C, G, C,2 |]

è«‹ç¢ºä¿å’Œå¼¦ç¬¦åˆäººé¡å½ˆå¥èƒ½åŠ›ï¼š
- å’Œå¼¦æœ€å¤šåŒ…å«3-4å€‹éŸ³ç¬¦
- éŸ³ç¬¦ä¹‹é–“çš„è·¨åº¦ä¸è¶…éä¸€å€‹å…«åº¦ï¼ˆ12å€‹åŠéŸ³ï¼‰
- å·¦æ‰‹å’Œå¼¦å»ºè­°åœ¨C2-C4ç¯„åœå…§
- å³æ‰‹æ—‹å¾‹å»ºè­°åœ¨C4-C6ç¯„åœå…§
- notes é™£åˆ—ä¸­çš„å’Œå¼¦å¿…é ˆç”¨å­—ä¸²é™£åˆ—è¡¨ç¤ºï¼Œå¦‚ ["C3", "E3", "G3"] è¡¨ç¤ºCå¤§èª¿å’Œå¼¦
- å–®éŸ³ç”¨å­—ä¸²è¡¨ç¤ºï¼Œå¦‚ "C4"
- velocity å€¼åœ¨ 0.1 åˆ° 0.8 ä¹‹é–“
- ä½¿ç”¨å¸¸è¦‹çš„å’Œå¼¦é€²è¡Œï¼Œå¦‚ C-Am-F-G æˆ– C-F-G-C
- ç¢ºä¿tempoæ¨™è¨˜æ­£ç¢ºï¼šQ:1/4=[å¯¦éš›BPMæ•¸å€¼]
- æ¯å€‹è²éƒ¨éƒ½å¿…é ˆä»¥ |] çµæŸï¼Œè¡¨ç¤ºæ¨‚æ›²çµæŸ
- ç¢ºä¿notesé™£åˆ—åŒ…å«å·¦å³æ‰‹çš„éŸ³ç¬¦ï¼Œå·¦æ‰‹ç”¨å’Œå¼¦ä¼´å¥ï¼Œå³æ‰‹ç”¨æ—‹å¾‹æˆ–å’Œå¼¦

ä¸»é¡Œæ˜¯ï¼š${userPrompt}`;

        try {
          const payload = {
            contents: [{ role: "user", parts: [{ text: fullPrompt }] }],
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  tempo: { type: "NUMBER" },
                  melody_description: { type: "STRING" },
                  notes: {
                    type: "ARRAY",
                    items: {
                      type: "OBJECT",
                      properties: {
                        time: { type: "STRING" },
                        note: {
                          oneOf: [
                            { type: "STRING" },
                            { type: "ARRAY", items: { type: "STRING" } },
                          ],
                        },
                        duration: { type: "STRING" },
                        velocity: {
                          type: "NUMBER",
                          minimum: 0.1,
                          maximum: 0.8,
                        },
                      },
                      required: ["time", "note", "duration", "velocity"],
                    },
                  },
                  abc_notation: { type: "STRING" },
                },
                required: [
                  "tempo",
                  "melody_description",
                  "notes",
                  "abc_notation",
                ],
              },
            },
          };
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            let errorDetails = `API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}`;
            try {
              const errorBody = await response.json();
              if (errorBody.error && errorBody.error.message) {
                errorDetails += ` - ${errorBody.error.message}`;
              }
            } catch (e) {}
            throw new Error(errorDetails);
          }
          const result = await response.json();
          console.log("Gemini API Response:", result);
          const data = JSON.parse(result.candidates[0].content.parts[0].text);

          resultText.innerHTML = `<strong>æ—‹å¾‹æè¿°ï¼š</strong>${data.melody_description}`;
          setupPlayback(data, data.abc_notation);
        } catch (error) {
          console.error("Gemini API å‘¼å«å¤±æ•—:", error);
          resultText.textContent = `ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}ã€‚`;
        } finally {
          loader.classList.add("hidden");
          checkApiKey();
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        generateBtn.onclick = handleGenerateClick;
        const apiKey = localStorage.getItem("geminiApiKey");
        if (apiKey) {
          apiKeySetupView.classList.add("hidden");
          apiKeyDisplayView.classList.remove("hidden");
        } else {
          apiKeySetupView.classList.remove("hidden");
          apiKeyDisplayView.classList.add("hidden");
        }
        checkApiKey();
      });
    </script>
  </body>
</html>
