<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI 鋼琴靈感產生器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Tone.js 核心 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- 新增：引入 abcjs 用於在頁面內渲染樂譜 -->
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.0/dist/abcjs-basic-min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans TC", sans-serif;
      }
      #svg-container {
        overflow: auto;
        border: 1px solid #e5e7eb;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 250px;
        background-color: #f9fafb;
        user-select: none;
        touch-action: none;
      }
      #piano-svg {
        width: 100%;
        transition: transform 0.2s ease-in-out;
        transform-origin: center;
      }
      #piano-svg rect:active,
      #piano-svg rect.playing {
        fill: #9ca3af !important;
      }
      #piano-svg.loading {
        opacity: 0.5;
        pointer-events: none;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-50 flex flex-col items-center justify-center min-h-screen p-4 sm:p-6"
  >
    <div class="w-full max-w-6xl bg-white p-5 sm:p-8 rounded-2xl shadow-lg">
      <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-2">
        AI 鋼琴靈感產生器
      </h1>
      <p class="text-center text-gray-500 mb-6">
        一個由 Gemini API 驅動的創意音樂工具
      </p>

      <div class="mb-8">
        <div class="flex items-center justify-center mb-4">
          <h2 class="text-xl font-semibold text-gray-700">互動式鋼琴 🔊</h2>
          <span id="loading-status" class="ml-4 text-sm text-blue-500"></span>
        </div>
        <div class="flex items-center justify-center space-x-4 mb-4">
          <button
            id="zoom-out"
            class="px-5 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors"
          >
            縮小 (-)
          </button>
          <span
            id="zoom-level"
            class="text-lg text-gray-600 font-medium w-36 text-center"
          ></span>
          <button
            id="zoom-in"
            class="px-5 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors"
          >
            放大 (+)
          </button>
        </div>

        <div
          id="svg-container"
          class="w-full bg-white rounded-lg p-4 overflow-x-auto"
        >
          <svg
            id="piano-svg"
            class="loading"
            viewBox="0 0 1197 120"
            xmlns="http://www.w3.org/2000/svg"
            version="1.1"
          >
            <desc>互動式 88 鍵鋼琴鍵盤</desc>
            <style>
              #white-keys rect:hover {
                fill: #e0e0e0;
                cursor: pointer;
              }
              #black-keys rect:hover {
                fill: #333333;
                cursor: pointer;
              }
            </style>
            <g id="white-keys">
              <rect
                data-note="A0"
                x="0"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B0"
                x="23"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C1"
                x="46"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D1"
                x="69"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E1"
                x="92"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F1"
                x="115"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G1"
                x="138"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A1"
                x="161"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B1"
                x="184"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C2"
                x="207"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D2"
                x="230"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E2"
                x="253"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F2"
                x="276"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G2"
                x="299"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A2"
                x="322"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B2"
                x="345"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C3"
                x="368"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D3"
                x="391"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E3"
                x="414"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F3"
                x="437"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G3"
                x="460"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A3"
                x="483"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B3"
                x="506"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C4"
                x="529"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D4"
                x="552"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E4"
                x="575"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F4"
                x="598"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G4"
                x="621"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A4"
                x="644"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B4"
                x="667"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C5"
                x="690"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D5"
                x="713"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E5"
                x="736"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F5"
                x="759"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G5"
                x="782"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A5"
                x="805"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B5"
                x="828"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C6"
                x="851"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D6"
                x="874"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E6"
                x="897"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F6"
                x="920"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G6"
                x="943"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A6"
                x="966"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B6"
                x="989"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C7"
                x="1012"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D7"
                x="1035"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E7"
                x="1058"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F7"
                x="1081"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G7"
                x="1104"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A7"
                x="1127"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B7"
                x="1150"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C8"
                x="1173"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
            </g>
            <g id="black-keys">
              <rect
                data-note="A#0"
                x="16.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#1"
                x="62.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#1"
                x="85.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#1"
                x="131.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#1"
                x="154.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#1"
                x="177.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#2"
                x="223.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#2"
                x="246.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#2"
                x="292.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#2"
                x="315.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#2"
                x="338.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#3"
                x="384.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#3"
                x="407.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#3"
                x="453.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#3"
                x="476.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#3"
                x="499.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#4"
                x="545.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#4"
                x="568.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#4"
                x="614.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#4"
                x="637.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#4"
                x="660.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#5"
                x="706.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#5"
                x="729.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#5"
                x="775.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#5"
                x="798.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#5"
                x="821.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#6"
                x="867.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#6"
                x="890.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#6"
                x="936.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#6"
                x="959.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#6"
                x="982.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#7"
                x="1028.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#7"
                x="1051.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#7"
                x="1097.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#7"
                x="1120.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#7"
                x="1143.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
            </g>
          </svg>
        </div>
      </div>

      <div class="border-t border-gray-200 pt-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">
          ✨ 產生旋律靈感
        </h2>
        <div class="max-w-2xl mx-auto">
          <div
            class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg"
          >
            <div id="api-key-display-view" class="hidden">
              <div class="flex justify-between items-center">
                <p class="text-sm font-medium text-green-800">
                  ✓ API 金鑰已設定
                </p>
                <button
                  id="clear-key-btn"
                  class="px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-colors"
                >
                  清除金鑰
                </button>
              </div>
            </div>
            <div id="api-key-setup-view">
              <label
                for="api-key-input"
                class="block text-sm font-medium text-gray-700 mb-2"
                >您的 Gemini API 金鑰</label
              >
              <div class="flex gap-2">
                <input
                  type="password"
                  id="api-key-input"
                  placeholder="請在此貼上您的 API 金鑰"
                  class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none transition"
                />
                <button
                  id="save-key-btn"
                  class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-sm hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-colors"
                >
                  儲存
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-2">
                您的金鑰只會儲存在您的瀏覽器中，不會上傳。
                <a
                  href="https://aistudio.google.com/"
                  target="_blank"
                  class="text-blue-600 hover:underline"
                  >點此免費取得金鑰</a
                >
              </p>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-4">
            <input
              type="text"
              id="prompt-input"
              placeholder="輸入一個主題，例如：星空下的營火"
              class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none transition"
            />
            <button
              id="generate-btn"
              class="w-full sm:w-auto px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition-colors flex items-center justify-center"
            >
              產生靈感
            </button>
          </div>
          <div
            id="result-container"
            class="mt-6 p-5 bg-gray-50 border border-gray-200 rounded-lg min-h-[100px] whitespace-pre-wrap"
          >
            <p id="result-text" class="text-gray-600">
              AI 產生的靈感將會顯示在這裡...
            </p>
            <div id="loader" class="hidden mx-auto loader"></div>
          </div>
          <!-- 播放控制區塊 -->
          <div
            id="playback-controls"
            class="hidden mt-4 flex justify-center items-center gap-4 p-4 bg-gray-100 rounded-lg"
          >
            <button
              id="play-pause-btn"
              class="px-5 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 transition-colors"
            >
              播放
            </button>
            <button
              id="stop-btn"
              class="px-5 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-sm hover:bg-gray-600 transition-colors"
            >
              停止
            </button>
          </div>
          <!-- 樂譜下載與預覽區塊 -->
          <div
            id="sheet-music-container"
            class="hidden mt-4 p-4 bg-gray-100 rounded-lg"
          >
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-semibold text-gray-700">音樂樂譜</h3>
              <button
                id="download-abc-btn"
                class="px-4 py-2 bg-indigo-500 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-indigo-600 transition-colors"
              >
                下載 .abc
              </button>
            </div>
            <!-- 內嵌樂譜預覽的容器 -->
            <div
              id="abc-score-preview"
              class="w-full bg-white p-2 rounded border border-gray-200 overflow-x-auto"
            ></div>
          </div>

          <!-- ABC 檔案載入區塊 -->
          <div class="mt-6 p-5 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center justify-center mb-4">
              <h3 class="text-lg font-semibold text-gray-700">
                📁 載入 ABC 檔案
              </h3>
            </div>
            <div class="flex flex-col items-center gap-4">
              <div class="w-full max-w-md">
                <input
                  type="file"
                  id="abc-file-input"
                  accept=".abc,.txt"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none transition file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
              </div>
              <button
                id="load-abc-btn"
                class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                載入並播放
              </button>
            </div>
            <div
              id="abc-file-status"
              class="mt-4 p-3 bg-white border border-gray-200 rounded-lg text-center text-gray-600 text-sm"
            >
              請選擇一個 .abc 檔案來載入樂譜
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- 全域變數與設定 ---
      const svgElement = document.getElementById("piano-svg");
      // 修正：加入 Compressor 和 Limiter 來防止爆音，並調整音量
      const compressor = new Tone.Compressor(-30, 3);
      const limiter = new Tone.Limiter(-6);
      const masterVolume = new Tone.Volume(-12); // 降低整體音量

      // 建立音效鏈：sampler -> compressor -> volume -> limiter -> destination
      compressor.connect(masterVolume);
      masterVolume.connect(limiter);
      limiter.toDestination();

      const sampler = new Tone.Sampler({
        urls: {
          A0: "A0.mp3",
          C1: "C1.mp3",
          "D#1": "Ds1.mp3",
          "F#1": "Fs1.mp3",
          A1: "A1.mp3",
          C2: "C2.mp3",
          "D#2": "Ds2.mp3",
          "F#2": "Fs2.mp3",
          A2: "A2.mp3",
          C3: "C3.mp3",
          "D#3": "Ds3.mp3",
          "F#3": "Fs3.mp3",
          A3: "A3.mp3",
          C4: "C4.mp3",
          "D#4": "Ds4.mp3",
          "F#4": "Fs4.mp3",
          A4: "A4.mp3",
          C5: "C5.mp3",
          "D#5": "Ds5.mp3",
          "F#5": "Fs5.mp3",
          A5: "A5.mp3",
          C6: "C6.mp3",
          "D#6": "Ds6.mp3",
          "F#6": "Fs6.mp3",
          A6: "A6.mp3",
          C7: "C7.mp3",
          "D#7": "Ds7.mp3",
          "F#7": "Fs7.mp3",
          A7: "A7.mp3",
          C8: "C8.mp3",
        },
        release: 1,
        attack: 0.005, // 加快音符起音
        baseUrl: "https://tonejs.github.io/audio/salamander/",
        onload: () => {
          document.getElementById("loading-status").textContent = "";
          svgElement.classList.remove("loading");
        },
      }).connect(compressor); // 將 sampler 連接到 compressor
      let currentPart = null;
      let scheduledStopEvent = null;

      // --- 縮放功能 ---
      const zoomInBtn = document.getElementById("zoom-in");
      const zoomOutBtn = document.getElementById("zoom-out");
      const zoomLevelDisplay = document.getElementById("zoom-level");
      let currentScale = 1.0;
      const zoomStep = 0.1;
      function updateZoom() {
        // We use transform: scale for zooming, but set the origin to the top-left
        // corner. This prevents the left side of the piano from being cut off when zoomed in.
        svgElement.style.transformOrigin = "0 0";
        svgElement.style.transform = `scale(${currentScale})`;
        zoomLevelDisplay.textContent = `目前縮放：${Math.round(
          currentScale * 100
        )}%`;
      }
      zoomInBtn.addEventListener("click", () => {
        currentScale += zoomStep;
        updateZoom();
      });
      zoomOutBtn.addEventListener("click", () => {
        if (currentScale > 0.2) {
          currentScale -= zoomStep;
          updateZoom();
        }
      });
      updateZoom();

      // --- 手動彈奏功能 ---
      const pianoContainer = document.getElementById("svg-container");
      let isMouseDown = false;
      const lastActiveElement = new Map();
      function playNoteFromElement(element, identifier = "mouse") {
        if (lastActiveElement.get(identifier) === element) return;
        if (Tone.context.state !== "running") Tone.context.resume();
        const note = element.dataset.note;
        if (note && sampler.loaded) {
          sampler.triggerAttack(note, Tone.now());
          lastActiveElement.set(identifier, element);
        }
      }
      function releaseAllNotes() {
        lastActiveElement.clear();
        sampler.releaseAll();
      }
      pianoContainer.addEventListener("mousedown", (e) => {
        if (e.target.matches("#piano-svg rect")) {
          isMouseDown = true;
          playNoteFromElement(e.target, "mouse");
        }
      });
      pianoContainer.addEventListener("mouseover", (e) => {
        if (isMouseDown && e.target.matches("#piano-svg rect")) {
          playNoteFromElement(e.target, "mouse");
        }
      });
      document.body.addEventListener("mouseup", () => {
        isMouseDown = false;
        releaseAllNotes();
      });
      document.body.addEventListener("mouseleave", () => {
        if (isMouseDown) {
          isMouseDown = false;
          releaseAllNotes();
        }
      });
      function handleTouch(event) {
        event.preventDefault();
        for (const touch of event.changedTouches) {
          const element = document.elementFromPoint(
            touch.clientX,
            touch.clientY
          );
          if (element && element.matches("#piano-svg rect")) {
            playNoteFromElement(element, touch.identifier);
          }
        }
      }
      pianoContainer.addEventListener("touchstart", handleTouch, {
        passive: false,
      });
      pianoContainer.addEventListener("touchmove", handleTouch, {
        passive: false,
      });
      pianoContainer.addEventListener("touchend", releaseAllNotes);
      pianoContainer.addEventListener("touchcancel", releaseAllNotes);

      // --- 自動演奏功能 ---
      const playbackControls = document.getElementById("playback-controls");
      const playPauseBtn = document.getElementById("play-pause-btn");
      const stopBtn = document.getElementById("stop-btn");
      const sheetMusicContainer = document.getElementById(
        "sheet-music-container"
      );
      const downloadAbcBtn = document.getElementById("download-abc-btn");
      const abcScorePreview = document.getElementById("abc-score-preview");

      function setupPlayback(sequence, abcString) {
        if (!sequence || !sampler.loaded) return;

        // 確保音訊 context 已啟動
        if (Tone.context.state !== "running") {
          Tone.context.resume();
        }

        // --- 徹底清理之前的設定 ---
        Tone.Transport.stop();
        Tone.Transport.cancel(); // 清除所有已排程的事件
        Tone.Transport.position = 0;

        // 如果有舊的 Part，先清理
        if (currentPart) {
          currentPart.dispose();
          currentPart = null;
        }
        // 清除舊的自動停止事件
        if (scheduledStopEvent) {
          Tone.Transport.clear(scheduledStopEvent);
          scheduledStopEvent = null;
        }
        // --- 清理結束 ---

        // 強制重置按鈕狀態
        playPauseBtn.textContent = "播放";

        // 從ABC記譜法中解析tempo（如果存在的話）
        let finalTempo = sequence.tempo || 100;
        const tempoMatch = abcString.match(/Q:1\/4=(\d+)/);
        if (tempoMatch) {
          finalTempo = parseInt(tempoMatch[1]);
        }
        Tone.Transport.bpm.value = finalTempo;

        const sortedNotes = sequence.notes.sort(
          (a, b) =>
            Tone.Time(a.time).toSeconds() - Tone.Time(b.time).toSeconds()
        );

        currentPart = new Tone.Part((time, value) => {
          const normalizedVelocity = Math.min(
            Math.max(value.velocity || 0.7, 0.1),
            0.8
          );
          sampler.triggerAttackRelease(
            value.note,
            value.duration,
            time,
            normalizedVelocity
          );
          Tone.Draw.schedule(() => {
            const notesToHighlight = Array.isArray(value.note)
              ? value.note
              : [value.note];
            notesToHighlight.forEach((note) => {
              const keyElement = document.querySelector(
                `[data-note="${note}"]`
              );
              if (keyElement) {
                keyElement.classList.add("playing");
                setTimeout(
                  () => keyElement.classList.remove("playing"),
                  Tone.Time(value.duration).toMilliseconds()
                );
              }
            });
          }, time);
        }, sortedNotes).start(0);

        currentPart.loop = false;

        // 計算總播放時間並設定自動停止
        const lastNote = sortedNotes[sortedNotes.length - 1];
        if (lastNote) {
          const endTime =
            Tone.Time(lastNote.time).toSeconds() +
            Tone.Time(lastNote.duration).toSeconds();
          // 使用 schedule (而不是 scheduleOnce) 以便在每次重播時都能觸發停止
          // 這個排程事件會在 setupPlayback 開始時的 Tone.Transport.cancel() 中被清除
          scheduledStopEvent = Tone.Transport.schedule(() => {
            Tone.Transport.stop();
          }, endTime + 0.1); // 加一點緩衝時間
        }

        playbackControls.classList.remove("hidden");
        sheetMusicContainer.classList.remove("hidden");

        // 渲染樂譜
        abcScorePreview.innerHTML = "";
        ABCJS.renderAbc(abcScorePreview, abcString, {
          responsive: "resize",
          staffwidth: 600,
          scale: 0.8,
          paddingright: 20,
          paddingleft: 20,
          paddingtop: 20,
          paddingbottom: 20,
          staffsep: 80,
          wrap: {
            minSpacing: 1.8,
            maxSpacing: 2.7,
            preferredMeasuresPerLine: 4,
          },
          format: {
            titlefont: "Times 16",
            gchordfont: "Times 12",
            annotationfont: "Times 12",
            vocalfont: "Times 12",
            wordsfont: "Times 12",
          },
        });

        downloadAbcBtn.onclick = () => {
          const blob = new Blob([abcString], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "ai-melody.abc";
          a.click();
          URL.revokeObjectURL(url);
        };
      }

      // --- 統一的事件監聽器 ---
      playPauseBtn.addEventListener("click", async () => {
        if (Tone.context.state !== "running") {
          await Tone.context.resume();
        }
        if (Tone.Transport.state === "started") {
          Tone.Transport.pause();
        } else {
          Tone.Transport.start();
        }
      });

      stopBtn.addEventListener("click", () => {
        Tone.Transport.stop();
      });

      // 監聽 Transport 狀態變化來更新UI
      Tone.Transport.on("start", () => {
        playPauseBtn.textContent = "暫停";
        console.log("Transport started, button set to '暫停'");
      });

      Tone.Transport.on("pause", () => {
        playPauseBtn.textContent = "繼續";
        console.log("Transport paused, button set to '繼續'");
      });

      Tone.Transport.on("stop", () => {
        playPauseBtn.textContent = "播放";
        Tone.Transport.position = 0;
        console.log("Transport stopped, button set to '播放'");
      });

      // --- ABC 檔案載入功能 ---
      const abcFileInput = document.getElementById("abc-file-input");
      const loadAbcBtn = document.getElementById("load-abc-btn");
      const abcFileStatus = document.getElementById("abc-file-status");

      // 啟用載入按鈕當檔案被選擇時
      abcFileInput.addEventListener("change", () => {
        if (abcFileInput.files.length > 0) {
          loadAbcBtn.disabled = false;
          loadAbcBtn.classList.remove("opacity-50", "cursor-not-allowed");
          abcFileStatus.textContent = `已選擇檔案: ${abcFileInput.files[0].name}`;
          abcFileStatus.classList.remove("text-gray-600");
          abcFileStatus.classList.add("text-blue-600");
        } else {
          loadAbcBtn.disabled = true;
          loadAbcBtn.classList.add("opacity-50", "cursor-not-allowed");
          abcFileStatus.textContent = "請選擇一個 .abc 檔案來載入樂譜";
          abcFileStatus.classList.remove("text-blue-600");
          abcFileStatus.classList.add("text-gray-600");
        }
      });

      // 解析 ABC 記譜法並轉換為音符序列
      function parseAbcToSequence(abcString) {
        try {
          console.log("開始解析 ABC 檔案:", abcString);

          // 提取基本資訊
          const tempoMatch = abcString.match(/Q:1\/4=(\d+)/);
          const tempo = tempoMatch ? parseInt(tempoMatch[1]) : 120;
          const meterMatch = abcString.match(/M:(\d+)\/(\d+)/);
          const meter = meterMatch
            ? { num: parseInt(meterMatch[1]), den: parseInt(meterMatch[2]) }
            : { num: 4, den: 4 };

          // 提取單位音符長度 (L: field)
          const lengthMatch = abcString.match(/L:1\/(\d+)/);
          const unitLength = lengthMatch ? parseInt(lengthMatch[1]) : 4; // 預設1/4
          const beatValue = 4 / unitLength; // 每個單位音符的拍數值

          console.log(
            `解析到 tempo: ${tempo}, meter: ${meter.num}/${meter.den}, unit length: 1/${unitLength} (${beatValue} 拍)`
          );

          // 分離不同聲部
          const lines = abcString.split("\n");
          let voice1Lines = [];
          let voice2Lines = [];
          let currentVoice = null;

          lines.forEach((line) => {
            if (line.startsWith("[V:1]")) {
              currentVoice = 1;
              // 提取聲部1的音符內容
              const content = line.substring(5).trim();
              if (content) voice1Lines.push(content);
            } else if (line.startsWith("[V:2")) {
              currentVoice = 2;
              // 提取聲部2的音符內容
              const content = line.substring(line.indexOf("]") + 1).trim();
              if (content) voice2Lines.push(content);
            } else if (currentVoice === 1 && !line.match(/^[XTMLKQ]:/)) {
              if (line.trim()) voice1Lines.push(line.trim());
            } else if (currentVoice === 2 && !line.match(/^[XTMLKQ]:/)) {
              if (line.trim()) voice2Lines.push(line.trim());
            }
          });

          console.log("聲部1內容:", voice1Lines);
          console.log("聲部2內容:", voice2Lines);

          const notes = [];

          // 解析聲部1（右手/高音）
          if (voice1Lines.length > 0) {
            const voice1Notes = parseVoiceLine(
              voice1Lines.join(" "),
              1,
              meter,
              beatValue
            );
            notes.push(...voice1Notes);
          }

          // 解析聲部2（左手/低音）
          if (voice2Lines.length > 0) {
            const voice2Notes = parseVoiceLine(
              voice2Lines.join(" "),
              2,
              meter,
              beatValue
            );
            notes.push(...voice2Notes);
          }

          console.log("解析完成，共", notes.length, "個音符事件");

          return {
            tempo: tempo,
            notes: notes,
          };
        } catch (error) {
          console.error("ABC 解析錯誤:", error);
          return null;
        }
      }

      // 解析單個聲部的音符
      function parseVoiceLine(voiceLine, voiceNumber, meter, beatValue = 1) {
        const notes = [];
        let totalBeats = 0; // 全局時間軸

        // 移除結束符號並按小節分割
        const measures = voiceLine
          .replace(/\|]/g, "")
          .split("|")
          .filter((m) => m.trim());

        const measureLength = meter.num; // 以拍數為單位

        measures.forEach((measure, measureIndex) => {
          // 追蹤小節內的拍數
          let measurePos = 0;
          console.log(
            `處理第${
              measureIndex + 1
            }小節 (聲部${voiceNumber}): "${measure.trim()}"`
          );

          // 分割音符/和弦 - 改進正則表達式處理複雜格式
          const tokens =
            measure
              .trim()
              .match(/\[[^\]]+\][\d\/]*|[A-Ga-g][#b,']*[\d\/]*|\S+/g) || [];

          tokens.forEach((token, idx) => {
            if (!token.trim()) return;

            // 計算原始時值
            let duration = parseDuration(token, beatValue);
            let cappedDuration = duration;

            // 若超過小節剩餘拍數，則只取剩餘拍數
            if (measurePos + duration > measureLength) {
              cappedDuration = measureLength - measurePos;
            }

            // 若是全分音符(或唯一音符)且剛好在小節開頭，直接延長到小節結束
            if (
              measurePos === 0 &&
              (duration >= measureLength ||
                (tokens.length === 1 && duration >= measureLength * 0.8))
            ) {
              cappedDuration = measureLength;
              console.log(`全分音符處理: ${token} 延長到 ${cappedDuration} 拍`);
            }

            // 構造音符事件
            const noteEvent = parseToken(
              token,
              totalBeats, // 使用全局時間
              voiceNumber,
              beatValue,
              meter,
              cappedDuration // 傳遞正確的時值
            );
            if (noteEvent) {
              notes.push(noteEvent);
              console.log(`添加音符事件:`, noteEvent);
            }

            measurePos += cappedDuration;
            totalBeats += cappedDuration;
          });
        });

        return notes;
      }

      // 解析單個音符/和弦token
      function parseToken(
        token,
        time,
        voiceNumber,
        beatValue = 1,
        meter = { num: 4, den: 4 },
        overrideDuration = null
      ) {
        // 檢查是否為和弦 [C,E,G,] 或 [CEG] 格式
        const chordMatch = token.match(/\[([^\]]+)\]/);
        if (chordMatch) {
          const chordNotes = [];
          // 分割和弦內容，處理逗號分隔和連續音符格式
          const chordContent = chordMatch[1];
          let noteStrings = [];

          // 檢查是否為逗號分隔格式 (如 "C,G,C") 或混合格式 (如 "G,B,D F")
          if (chordContent.includes(",")) {
            // 先按空格分割，再處理每個部分的逗號
            const spaceParts = chordContent.split(/\s+/);
            noteStrings = [];

            for (const spacePart of spaceParts) {
              if (spacePart.includes(",")) {
                // 處理逗號分隔的部分 (如 "G,B,D")
                const commaParts = spacePart.split(",");
                for (let i = 0; i < commaParts.length; i++) {
                  const part = commaParts[i].trim();
                  if (!part) continue;

                  if (i < commaParts.length - 1) {
                    // 不是最後一個部分，添加逗號表示低八度
                    noteStrings.push(part + ",");
                  } else {
                    // 最後一個部分，保持原樣
                    noteStrings.push(part);
                  }
                }
              } else {
                // 沒有逗號的部分，直接添加
                noteStrings.push(spacePart.trim());
              }
            }
          } else {
            // 處理空格分隔的音符格式 (如 "c e g c'") 和連續音符格式 (如 "CEG")
            if (chordContent.includes(" ")) {
              // 空格分隔的音符
              noteStrings = chordContent.split(/\s+/).filter((n) => n.trim());
            } else {
              // 連續音符格式，使用正則表達式分割
              noteStrings = chordContent.match(/[A-Ga-g][#b]?[',]*/g) || [];
            }
          }

          console.log(`解析和弦 ${token}:`, noteStrings);
          console.log(`和弦內容: "${chordContent}"`);

          for (const noteStr of noteStrings) {
            const note = convertAbcToToneJs(noteStr.trim(), voiceNumber);
            if (note) {
              chordNotes.push(note);
              console.log(`和弦音符: ${noteStr} -> ${note}`);
            } else {
              console.warn(`無法轉換音符: ${noteStr}`);
            }
          }

          if (chordNotes.length > 0) {
            return {
              time: `${time}*${beatValue}`,
              note: chordNotes,
              duration: getDurationString(
                overrideDuration !== null
                  ? overrideDuration
                  : parseDuration(token, beatValue)
              ),
              velocity: 0.6,
            };
          }
        } else {
          // 單個音符
          const note = convertAbcToToneJs(token, voiceNumber);
          if (note) {
            return {
              time: `${time}*${beatValue}`,
              note: note,
              duration: getDurationString(
                overrideDuration !== null
                  ? overrideDuration
                  : parseDuration(token, beatValue)
              ),
              velocity: 0.6,
            };
          }
        }

        return null;
      }

      // 解析音符持續時間
      function parseDuration(token, beatValue = 1) {
        // 移除和弦括號來檢查持續時間
        const cleanToken = token.replace(/[\[\]]/g, "");

        // 檢查分數記號 (如 C/2, G/4)
        const fractionMatch = cleanToken.match(/\/(\d+)/);
        if (fractionMatch) {
          return (1 / parseFloat(fractionMatch[1])) * beatValue;
        }

        // 檢查數字後綴 (如 G2, C4)
        const durationMatch = cleanToken.match(/(\d+)$/);
        if (durationMatch) {
          return parseFloat(durationMatch[1]) * beatValue;
        }

        // 預設單位長度
        return beatValue;
      }

      // 將數字持續時間轉換為 Tone.js 字串格式
      function getDurationString(beats) {
        // 支援超過4拍的自訂時值（如6/4、3/2等）
        if (beats >= 4) return "1n"; // 全音符及以上都用全音符
        if (beats >= 3) return "2n."; // 附點二分音符
        if (beats >= 2) return "2n"; // 二分音符
        if (beats >= 1.5) return "4n."; // 附點四分音符
        if (beats >= 1) return "4n"; // 四分音符
        if (beats >= 0.75) return "8n."; // 附點八分音符
        if (beats >= 0.5) return "8n"; // 八分音符
        return "16n"; // 十六分音符
      }

      // 將 ABC 記譜法的音符轉換為 Tone.js 格式
      function convertAbcToToneJs(abcNote, voiceNumber = 1) {
        if (!abcNote || abcNote.trim() === "") return null;

        // 先移除時長標記，例如 "C4" -> "C", "g/2" -> "g"
        const noteOnly = abcNote.replace(/[\d/]+$/, "");

        // 移除非音符字符，但保留大小寫信息
        const cleanNote = noteOnly.replace(/[^\w#b',]/g, "");
        if (!cleanNote) return null;

        // 基本音符映射
        let note = cleanNote.charAt(0);
        let accidental = "";
        let octave;

        // ABC 記譜法：大寫字母為低八度，小寫字母為高八度
        if (note >= "A" && note <= "G") {
          // 大寫字母 (低八度)
          note = note.toUpperCase();
          octave = voiceNumber === 1 ? 4 : 3; // 聲部1預設4，聲部2預設3
        } else if (note >= "a" && note <= "g") {
          // 小寫字母 (高八度)
          note = note.toUpperCase();
          octave = voiceNumber === 1 ? 5 : 4; // 小寫字母比大寫高一個八度
        } else {
          return null;
        }

        // 處理升降號
        if (cleanNote.includes("#")) accidental = "#";
        if (cleanNote.includes("b")) accidental = "b";

        // 處理八度標記
        const commaCount = (cleanNote.match(/,/g) || []).length;
        const apostropheCount = (cleanNote.match(/'/g) || []).length;

        // ABC記譜法中，逗號降八度，撇號升八度
        octave = octave - commaCount + apostropheCount;

        // 確保八度在合理範圍內
        octave = Math.max(0, Math.min(8, octave));

        const result = `${note}${accidental}${octave}`;
        console.log(
          `轉換音符: ${abcNote} -> ${result} (聲部${voiceNumber}, 逗號:${commaCount}, 撇號:${apostropheCount})`
        );
        return result;
      }

      // 載入 ABC 檔案功能
      loadAbcBtn.addEventListener("click", async () => {
        const file = abcFileInput.files[0];
        if (!file) {
          alert("請先選擇一個檔案！");
          return;
        }

        try {
          abcFileStatus.textContent = "正在載入檔案...";
          abcFileStatus.classList.remove(
            "text-blue-600",
            "text-green-600",
            "text-red-600"
          );
          abcFileStatus.classList.add("text-orange-600");

          const fileContent = await file.text();
          console.log("載入的 ABC 內容:", fileContent);

          // 解析 ABC 檔案
          const sequence = parseAbcToSequence(fileContent);

          if (!sequence || !sequence.notes || sequence.notes.length === 0) {
            throw new Error("無法解析 ABC 檔案或檔案中沒有有效的音符");
          }

          // 顯示解析結果的詳細信息
          console.log("解析結果摘要:");
          console.log("- 總音符數:", sequence.notes.length);
          console.log("- Tempo:", sequence.tempo);
          console.log("- 前5個音符:", sequence.notes.slice(0, 5));

          // 檢查音符的時間分佈
          const timings = sequence.notes.map((n) => n.time).sort();
          console.log(
            "- 時間範圍:",
            timings[0],
            "到",
            timings[timings.length - 1]
          );

          // 設定播放功能
          setupPlayback(sequence, fileContent);

          // 更新結果顯示
          resultText.innerHTML = `<strong>已載入 ABC 檔案：</strong>${file.name}<br><strong>音符數量：</strong>${sequence.notes.length}<br><strong>速度：</strong>${sequence.tempo} BPM`;

          abcFileStatus.textContent = `✓ 成功載入檔案: ${file.name}`;
          abcFileStatus.classList.remove("text-orange-600");
          abcFileStatus.classList.add("text-green-600");
        } catch (error) {
          console.error("載入 ABC 檔案失敗:", error);
          abcFileStatus.textContent = `✗ 載入失敗: ${error.message}`;
          abcFileStatus.classList.remove("text-orange-600");
          abcFileStatus.classList.add("text-red-600");

          resultText.textContent = `載入 ABC 檔案時發生錯誤：${error.message}`;
        }
      });

      // --- Gemini API 功能 ---
      const generateBtn = document.getElementById("generate-btn");
      const promptInput = document.getElementById("prompt-input");
      const resultText = document.getElementById("result-text");
      const loader = document.getElementById("loader");
      const apiKeyInput = document.getElementById("api-key-input");
      const saveKeyBtn = document.getElementById("save-key-btn");
      const clearKeyBtn = document.getElementById("clear-key-btn");
      const apiKeySetupView = document.getElementById("api-key-setup-view");
      const apiKeyDisplayView = document.getElementById("api-key-display-view");

      function checkApiKey() {
        const apiKey = localStorage.getItem("geminiApiKey");
        if (apiKey) {
          apiKeySetupView.classList.add("hidden");
          apiKeyDisplayView.classList.remove("hidden");
          // 檢查輸入框是否有內容才啟用按鈕
          updateGenerateButtonState();
        } else {
          apiKeySetupView.classList.remove("hidden");
          apiKeyDisplayView.classList.add("hidden");
          generateBtn.disabled = true;
          generateBtn.classList.add("opacity-50", "cursor-not-allowed");
          resultText.textContent =
            "請先在上方設定您的 Gemini API 金鑰以啟用此功能。";
        }
      }

      function updateGenerateButtonState() {
        const apiKey = localStorage.getItem("geminiApiKey");
        const hasPrompt = promptInput.value.trim().length > 0;

        if (apiKey && hasPrompt) {
          generateBtn.disabled = false;
          generateBtn.classList.remove("opacity-50", "cursor-not-allowed");
        } else {
          generateBtn.disabled = true;
          generateBtn.classList.add("opacity-50", "cursor-not-allowed");
        }
      }

      saveKeyBtn.addEventListener("click", () => {
        const apiKey = apiKeyInput.value.trim();
        if (apiKey) {
          localStorage.setItem("geminiApiKey", apiKey);
          alert("API 金鑰已儲存！");
          checkApiKey();
          resultText.textContent = "已載入您的 API 金鑰，可以開始產生靈感了！";
        } else {
          alert("請輸入有效的 API 金鑰。");
        }
      });

      clearKeyBtn.addEventListener("click", () => {
        localStorage.removeItem("geminiApiKey");
        alert("API 金鑰已清除！");
        checkApiKey();
      });

      promptInput.addEventListener("input", () => {
        playbackControls.classList.add("hidden");
        sheetMusicContainer.classList.add("hidden");
        Tone.Transport.stop();

        updateGenerateButtonState();
      });

      async function handleGenerateClick() {
        const apiKey = localStorage.getItem("geminiApiKey");
        if (!apiKey) {
          alert("請先儲存您的 Gemini API 金鑰！");
          return;
        }
        const userPrompt = promptInput.value.trim();
        if (!userPrompt) {
          resultText.textContent = "請先輸入一個主題或情境！";
          return;
        }

        resultText.textContent = "";
        loader.classList.remove("hidden");
        generateBtn.disabled = true;
        generateBtn.classList.add("opacity-50", "cursor-not-allowed");
        playbackControls.classList.add("hidden");
        sheetMusicContainer.classList.add("hidden");

        // 修正：強化 ABC 譜的 prompt，要求包含正確的鋼琴譜格式
        const fullPrompt = `你是一位精通樂理的AI作曲家。根據以下主題，創作一段8到16小節，適合鋼琴獨奏的簡短音樂。請包含旋律和和弦伴奏。請以JSON格式回傳，包含：

1. 'tempo' (BPM速度，建議60-120)
2. 'melody_description' (旋律描述文字)
3. 'notes' (音符物件陣列，每個物件包含 'time', 'note' (可以是字串或字串陣列，陣列表示和弦), 'duration', 'velocity' (0.1-0.8之間))
4. 'abc_notation' (標準ABC譜格式的字串，必須包含完整標頭並使用正確的鋼琴譜格式)

ABC記譜法要求：
- 標頭格式：X:1\\nT:${userPrompt}\\nM:4/4\\nL:1/4\\nK:C\\nQ:1/4=[tempo]
- 使用雙五線譜格式，右手高音譜記號，左手低音譜記號
- 右手部分（高音譜記號）：[V:1] 音域建議在C-c'之間（C4-C6）
- 左手部分（低音譜記號）：[V:2 clef=bass] 音域建議在C,-C之間（C2-C4）
- 和弦表示法：右手用[CEG]，左手用[C,E,G,]（逗號表示低八度）
- 小節線用 | 分隔，樂曲結束必須用 |] （雙線表示結束）
- 確保每個聲部都有結束標記
- 範例格式：
  [V:1] C E G c | F A c f | G E C2 |]
  [V:2 clef=bass] C, E, G, C | F, A, C F | C, G, C,2 |]

請確保和弦符合人類彈奏能力：
- 和弦最多包含3-4個音符
- 音符之間的跨度不超過一個八度（12個半音）
- 左手和弦建議在C2-C4範圍內
- 右手旋律建議在C4-C6範圍內
- notes 陣列中的和弦必須用字串陣列表示，如 ["C3", "E3", "G3"] 表示C大調和弦
- 單音用字串表示，如 "C4"
- velocity 值在 0.1 到 0.8 之間
- 使用常見的和弦進行，如 C-Am-F-G 或 C-F-G-C
- 確保tempo標記正確：Q:1/4=[實際BPM數值]
- 每個聲部都必須以 |] 結束，表示樂曲結束
- 確保notes陣列包含左右手的音符，左手用和弦伴奏，右手用旋律或和弦

主題是：${userPrompt}`;

        try {
          const payload = {
            contents: [{ role: "user", parts: [{ text: fullPrompt }] }],
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  tempo: { type: "NUMBER" },
                  melody_description: { type: "STRING" },
                  notes: {
                    type: "ARRAY",
                    items: {
                      type: "OBJECT",
                      properties: {
                        time: { type: "STRING" },
                        note: {
                          oneOf: [
                            { type: "STRING" },
                            { type: "ARRAY", items: { type: "STRING" } },
                          ],
                        },
                        duration: { type: "STRING" },
                        velocity: {
                          type: "NUMBER",
                          minimum: 0.1,
                          maximum: 0.8,
                        },
                      },
                      required: ["time", "note", "duration", "velocity"],
                    },
                  },
                  abc_notation: { type: "STRING" },
                },
                required: [
                  "tempo",
                  "melody_description",
                  "notes",
                  "abc_notation",
                ],
              },
            },
          };
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            let errorDetails = `API 請求失敗，狀態碼：${response.status}`;
            try {
              const errorBody = await response.json();
              if (errorBody.error && errorBody.error.message) {
                errorDetails += ` - ${errorBody.error.message}`;
              }
            } catch (e) {}
            throw new Error(errorDetails);
          }
          const result = await response.json();
          console.log("Gemini API Response:", result);
          const data = JSON.parse(result.candidates[0].content.parts[0].text);

          resultText.innerHTML = `<strong>旋律描述：</strong>${data.melody_description}`;

          // 直接使用ABC解析器來確保一致的格式
          const sequence = parseAbcToSequence(data.abc_notation);
          if (sequence) {
            setupPlayback(sequence, data.abc_notation);
          } else {
            // 如果ABC解析失敗，嘗試使用原始數據但會觸發重新解析
            console.log("ABC解析失敗，使用原始數據並將觸發重新解析");
            setupPlayback(data, data.abc_notation);
          }
        } catch (error) {
          console.error("Gemini API 呼叫失敗:", error);
          resultText.textContent = `發生錯誤：${error.message}。`;
        } finally {
          loader.classList.add("hidden");
          checkApiKey();
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        generateBtn.onclick = handleGenerateClick;
        const apiKey = localStorage.getItem("geminiApiKey");
        if (apiKey) {
          apiKeySetupView.classList.add("hidden");
          apiKeyDisplayView.classList.remove("hidden");
        } else {
          apiKeySetupView.classList.remove("hidden");
          apiKeyDisplayView.classList.add("hidden");
        }
        checkApiKey();
      });

      // 頁面載入時檢查API金鑰狀態
      checkApiKey();
    </script>
  </body>
</html>
