<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI é‹¼ç´éˆæ„Ÿç”¢ç”Ÿå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Tone.js æ ¸å¿ƒ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- æ–°å¢ï¼šå¼•å…¥ abcjs ç”¨æ–¼åœ¨é é¢å…§æ¸²æŸ“æ¨‚è­œ -->
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.0/dist/abcjs-basic-min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans TC", sans-serif;
      }
      #svg-container {
        overflow: auto;
        border: 1px solid #e5e7eb;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 250px;
        background-color: #f9fafb;
        user-select: none;
        touch-action: none;
      }
      #piano-svg {
        width: 100%;
        transition: transform 0.2s ease-in-out;
        transform-origin: center;
      }
      #piano-svg rect:active,
      #piano-svg rect.playing {
        fill: #9ca3af !important;
      }
      #piano-svg.loading {
        opacity: 0.5;
        pointer-events: none;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-50 flex flex-col items-center justify-center min-h-screen p-4 sm:p-6"
  >
    <div class="w-full max-w-6xl bg-white p-5 sm:p-8 rounded-2xl shadow-lg">
      <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-2">
        AI é‹¼ç´éˆæ„Ÿç”¢ç”Ÿå™¨
      </h1>
      <p class="text-center text-gray-500 mb-6">
        ä¸€å€‹ç”± Gemini API é©…å‹•çš„å‰µæ„éŸ³æ¨‚å·¥å…·
      </p>

      <div class="mb-8">
        <div class="flex items-center justify-center mb-4">
          <h2 class="text-xl font-semibold text-gray-700">äº’å‹•å¼é‹¼ç´ ğŸ”Š</h2>
          <span id="loading-status" class="ml-4 text-sm text-blue-500"></span>
        </div>
        <div class="flex items-center justify-center space-x-4 mb-4">
          <button
            id="zoom-out"
            class="px-5 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors"
          >
            ç¸®å° (-)
          </button>
          <span
            id="zoom-level"
            class="text-lg text-gray-600 font-medium w-36 text-center"
          ></span>
          <button
            id="zoom-in"
            class="px-5 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors"
          >
            æ”¾å¤§ (+)
          </button>
        </div>

        <div
          id="svg-container"
          class="w-full bg-white rounded-lg p-4 overflow-x-auto"
        >
          <svg
            id="piano-svg"
            class="loading"
            viewBox="0 0 1197 120"
            xmlns="http://www.w3.org/2000/svg"
            version="1.1"
          >
            <desc>äº’å‹•å¼ 88 éµé‹¼ç´éµç›¤</desc>
            <style>
              #white-keys rect:hover {
                fill: #e0e0e0;
                cursor: pointer;
              }
              #black-keys rect:hover {
                fill: #333333;
                cursor: pointer;
              }
            </style>
            <g id="white-keys">
              <rect
                data-note="A0"
                x="0"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B0"
                x="23"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C1"
                x="46"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D1"
                x="69"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E1"
                x="92"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F1"
                x="115"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G1"
                x="138"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A1"
                x="161"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B1"
                x="184"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C2"
                x="207"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D2"
                x="230"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E2"
                x="253"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F2"
                x="276"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G2"
                x="299"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A2"
                x="322"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B2"
                x="345"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C3"
                x="368"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D3"
                x="391"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E3"
                x="414"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F3"
                x="437"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G3"
                x="460"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A3"
                x="483"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B3"
                x="506"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C4"
                x="529"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D4"
                x="552"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E4"
                x="575"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F4"
                x="598"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G4"
                x="621"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A4"
                x="644"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B4"
                x="667"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C5"
                x="690"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D5"
                x="713"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E5"
                x="736"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F5"
                x="759"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G5"
                x="782"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A5"
                x="805"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B5"
                x="828"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C6"
                x="851"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D6"
                x="874"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E6"
                x="897"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F6"
                x="920"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G6"
                x="943"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A6"
                x="966"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B6"
                x="989"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C7"
                x="1012"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="D7"
                x="1035"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="E7"
                x="1058"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="F7"
                x="1081"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="G7"
                x="1104"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="A7"
                x="1127"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="B7"
                x="1150"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
              <rect
                data-note="C8"
                x="1173"
                y="0"
                width="23"
                height="120"
                fill="#FFFFFF"
                stroke="#000000"
                stroke-width="1"
              />
            </g>
            <g id="black-keys">
              <rect
                data-note="A#0"
                x="16.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#1"
                x="62.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#1"
                x="85.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#1"
                x="131.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#1"
                x="154.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#1"
                x="177.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#2"
                x="223.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#2"
                x="246.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#2"
                x="292.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#2"
                x="315.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#2"
                x="338.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#3"
                x="384.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#3"
                x="407.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#3"
                x="453.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#3"
                x="476.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#3"
                x="499.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#4"
                x="545.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#4"
                x="568.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#4"
                x="614.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#4"
                x="637.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#4"
                x="660.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#5"
                x="706.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#5"
                x="729.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#5"
                x="775.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#5"
                x="798.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#5"
                x="821.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#6"
                x="867.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#6"
                x="890.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#6"
                x="936.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#6"
                x="959.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#6"
                x="982.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="C#7"
                x="1028.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="D#7"
                x="1051.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="F#7"
                x="1097.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="G#7"
                x="1120.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
              <rect
                data-note="A#7"
                x="1143.5"
                y="0"
                width="13"
                height="80"
                fill="#000000"
              />
            </g>
          </svg>
        </div>
      </div>

      <div class="border-t border-gray-200 pt-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">
          âœ¨ ç”¢ç”Ÿæ—‹å¾‹éˆæ„Ÿ
        </h2>
        <div class="max-w-2xl mx-auto">
          <div
            class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg"
          >
            <div id="api-key-display-view" class="hidden">
              <div class="flex justify-between items-center">
                <p class="text-sm font-medium text-green-800">
                  âœ“ API é‡‘é‘°å·²è¨­å®š
                </p>
                <button
                  id="clear-key-btn"
                  class="px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-colors"
                >
                  æ¸…é™¤é‡‘é‘°
                </button>
              </div>
            </div>
            <div id="api-key-setup-view">
              <label
                for="api-key-input"
                class="block text-sm font-medium text-gray-700 mb-2"
                >æ‚¨çš„ Gemini API é‡‘é‘°</label
              >
              <div class="flex gap-2">
                <input
                  type="password"
                  id="api-key-input"
                  placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API é‡‘é‘°"
                  class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:outline-none transition"
                />
                <button
                  id="save-key-btn"
                  class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-sm hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-colors"
                >
                  å„²å­˜
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-2">
                æ‚¨çš„é‡‘é‘°åªæœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³ã€‚
                <a
                  href="https://aistudio.google.com/"
                  target="_blank"
                  class="text-blue-600 hover:underline"
                  >é»æ­¤å…è²»å–å¾—é‡‘é‘°</a
                >
              </p>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-4">
            <input
              type="text"
              id="prompt-input"
              placeholder="è¼¸å…¥ä¸€å€‹ä¸»é¡Œï¼Œä¾‹å¦‚ï¼šæ˜Ÿç©ºä¸‹çš„ç‡Ÿç«"
              class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none transition"
            />
            <button
              id="generate-btn"
              class="w-full sm:w-auto px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition-colors flex items-center justify-center"
            >
              ç”¢ç”Ÿéˆæ„Ÿ
            </button>
          </div>
          <div
            id="result-container"
            class="mt-6 p-5 bg-gray-50 border border-gray-200 rounded-lg min-h-[100px] whitespace-pre-wrap"
          >
            <p id="result-text" class="text-gray-600">
              AI ç”¢ç”Ÿçš„éˆæ„Ÿå°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡...
            </p>
            <div id="loader" class="hidden mx-auto loader"></div>
          </div>
          <!-- æ’­æ”¾æ§åˆ¶å€å¡Š -->
          <div
            id="playback-controls"
            class="hidden mt-4 flex justify-center items-center gap-4 p-4 bg-gray-100 rounded-lg"
          >
            <button
              id="play-pause-btn"
              class="px-5 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 transition-colors"
            >
              æ’­æ”¾
            </button>
            <button
              id="stop-btn"
              class="px-5 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-sm hover:bg-gray-600 transition-colors"
            >
              åœæ­¢
            </button>
          </div>
          <!-- æ¨‚è­œä¸‹è¼‰èˆ‡é è¦½å€å¡Š -->
          <div
            id="sheet-music-container"
            class="hidden mt-4 p-4 bg-gray-100 rounded-lg"
          >
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-semibold text-gray-700">éŸ³æ¨‚æ¨‚è­œ</h3>
              <button
                id="download-abc-btn"
                class="px-4 py-2 bg-indigo-500 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-indigo-600 transition-colors"
              >
                ä¸‹è¼‰ .abc
              </button>
            </div>
            <!-- å…§åµŒæ¨‚è­œé è¦½çš„å®¹å™¨ -->
            <div
              id="abc-score-preview"
              class="w-full bg-white p-2 rounded border border-gray-200 overflow-x-auto"
            ></div>
          </div>

          <!-- ABC æª”æ¡ˆè¼‰å…¥å€å¡Š -->
          <div class="mt-6 p-5 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center justify-center mb-4">
              <h3 class="text-lg font-semibold text-gray-700">
                ğŸ“ è¼‰å…¥ ABC æª”æ¡ˆ
              </h3>
            </div>
            <div class="flex flex-col items-center gap-4">
              <div class="w-full max-w-md">
                <input
                  type="file"
                  id="abc-file-input"
                  accept=".abc,.txt"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none transition file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
              </div>
              <button
                id="load-abc-btn"
                class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                è¼‰å…¥ä¸¦æ’­æ”¾
              </button>
            </div>
            <div
              id="abc-file-status"
              class="mt-4 p-3 bg-white border border-gray-200 rounded-lg text-center text-gray-600 text-sm"
            >
              è«‹é¸æ“‡ä¸€å€‹ .abc æª”æ¡ˆä¾†è¼‰å…¥æ¨‚è­œ
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š ---
      const svgElement = document.getElementById("piano-svg");
      // ä¿®æ­£ï¼šåŠ å…¥ Compressor å’Œ Limiter ä¾†é˜²æ­¢çˆ†éŸ³ï¼Œä¸¦èª¿æ•´éŸ³é‡
      const compressor = new Tone.Compressor(-30, 3);
      const limiter = new Tone.Limiter(-6);
      const masterVolume = new Tone.Volume(-12); // é™ä½æ•´é«”éŸ³é‡

      // å»ºç«‹éŸ³æ•ˆéˆï¼šsampler -> compressor -> volume -> limiter -> destination
      compressor.connect(masterVolume);
      masterVolume.connect(limiter);
      limiter.toDestination();

      const sampler = new Tone.Sampler({
        urls: {
          A0: "A0.mp3",
          C1: "C1.mp3",
          "D#1": "Ds1.mp3",
          "F#1": "Fs1.mp3",
          A1: "A1.mp3",
          C2: "C2.mp3",
          "D#2": "Ds2.mp3",
          "F#2": "Fs2.mp3",
          A2: "A2.mp3",
          C3: "C3.mp3",
          "D#3": "Ds3.mp3",
          "F#3": "Fs3.mp3",
          A3: "A3.mp3",
          C4: "C4.mp3",
          "D#4": "Ds4.mp3",
          "F#4": "Fs4.mp3",
          A4: "A4.mp3",
          C5: "C5.mp3",
          "D#5": "Ds5.mp3",
          "F#5": "Fs5.mp3",
          A5: "A5.mp3",
          C6: "C6.mp3",
          "D#6": "Ds6.mp3",
          "F#6": "Fs6.mp3",
          A6: "A6.mp3",
          C7: "C7.mp3",
          "D#7": "Ds7.mp3",
          "F#7": "Fs7.mp3",
          A7: "A7.mp3",
          C8: "C8.mp3",
        },
        release: 1,
        attack: 0.005, // åŠ å¿«éŸ³ç¬¦èµ·éŸ³
        baseUrl: "https://tonejs.github.io/audio/salamander/",
        onload: () => {
          document.getElementById("loading-status").textContent = "";
          svgElement.classList.remove("loading");
        },
      }).connect(compressor); // å°‡ sampler é€£æ¥åˆ° compressor
      let currentPart = null;
      let scheduledStopEvent = null;

      // --- ç¸®æ”¾åŠŸèƒ½ ---
      const zoomInBtn = document.getElementById("zoom-in");
      const zoomOutBtn = document.getElementById("zoom-out");
      const zoomLevelDisplay = document.getElementById("zoom-level");
      let currentScale = 1.0;
      const zoomStep = 0.1;
      function updateZoom() {
        // We use transform: scale for zooming, but set the origin to the top-left
        // corner. This prevents the left side of the piano from being cut off when zoomed in.
        svgElement.style.transformOrigin = "0 0";
        svgElement.style.transform = `scale(${currentScale})`;
        zoomLevelDisplay.textContent = `ç›®å‰ç¸®æ”¾ï¼š${Math.round(
          currentScale * 100
        )}%`;
      }
      zoomInBtn.addEventListener("click", () => {
        currentScale += zoomStep;
        updateZoom();
      });
      zoomOutBtn.addEventListener("click", () => {
        if (currentScale > 0.2) {
          currentScale -= zoomStep;
          updateZoom();
        }
      });
      updateZoom();

      // --- æ‰‹å‹•å½ˆå¥åŠŸèƒ½ ---
      const pianoContainer = document.getElementById("svg-container");
      let isMouseDown = false;
      const lastActiveElement = new Map();
      function playNoteFromElement(element, identifier = "mouse") {
        if (lastActiveElement.get(identifier) === element) return;
        if (Tone.context.state !== "running") Tone.context.resume();
        const note = element.dataset.note;
        if (note && sampler.loaded) {
          sampler.triggerAttack(note, Tone.now());
          lastActiveElement.set(identifier, element);
        }
      }
      function releaseAllNotes() {
        lastActiveElement.clear();
        sampler.releaseAll();
      }
      pianoContainer.addEventListener("mousedown", (e) => {
        if (e.target.matches("#piano-svg rect")) {
          isMouseDown = true;
          playNoteFromElement(e.target, "mouse");
        }
      });
      pianoContainer.addEventListener("mouseover", (e) => {
        if (isMouseDown && e.target.matches("#piano-svg rect")) {
          playNoteFromElement(e.target, "mouse");
        }
      });
      document.body.addEventListener("mouseup", () => {
        isMouseDown = false;
        releaseAllNotes();
      });
      document.body.addEventListener("mouseleave", () => {
        if (isMouseDown) {
          isMouseDown = false;
          releaseAllNotes();
        }
      });
      function handleTouch(event) {
        event.preventDefault();
        for (const touch of event.changedTouches) {
          const element = document.elementFromPoint(
            touch.clientX,
            touch.clientY
          );
          if (element && element.matches("#piano-svg rect")) {
            playNoteFromElement(element, touch.identifier);
          }
        }
      }
      pianoContainer.addEventListener("touchstart", handleTouch, {
        passive: false,
      });
      pianoContainer.addEventListener("touchmove", handleTouch, {
        passive: false,
      });
      pianoContainer.addEventListener("touchend", releaseAllNotes);
      pianoContainer.addEventListener("touchcancel", releaseAllNotes);

      // --- è‡ªå‹•æ¼”å¥åŠŸèƒ½ ---
      const playbackControls = document.getElementById("playback-controls");
      const playPauseBtn = document.getElementById("play-pause-btn");
      const stopBtn = document.getElementById("stop-btn");
      const sheetMusicContainer = document.getElementById(
        "sheet-music-container"
      );
      const downloadAbcBtn = document.getElementById("download-abc-btn");
      const abcScorePreview = document.getElementById("abc-score-preview");

      function setupPlayback(sequence, abcString) {
        if (!sequence || !sampler.loaded) return;

        // ç¢ºä¿éŸ³è¨Š context å·²å•Ÿå‹•
        if (Tone.context.state !== "running") {
          Tone.context.resume();
        }

        // --- å¾¹åº•æ¸…ç†ä¹‹å‰çš„è¨­å®š ---
        Tone.Transport.stop();
        Tone.Transport.cancel(); // æ¸…é™¤æ‰€æœ‰å·²æ’ç¨‹çš„äº‹ä»¶
        Tone.Transport.position = 0;

        // å¦‚æœæœ‰èˆŠçš„ Partï¼Œå…ˆæ¸…ç†
        if (currentPart) {
          currentPart.dispose();
          currentPart = null;
        }
        // æ¸…é™¤èˆŠçš„è‡ªå‹•åœæ­¢äº‹ä»¶
        if (scheduledStopEvent) {
          Tone.Transport.clear(scheduledStopEvent);
          scheduledStopEvent = null;
        }
        // --- æ¸…ç†çµæŸ ---

        // å¼·åˆ¶é‡ç½®æŒ‰éˆ•ç‹€æ…‹
        playPauseBtn.textContent = "æ’­æ”¾";

        // å¾ABCè¨˜è­œæ³•ä¸­è§£ætempoï¼ˆå¦‚æœå­˜åœ¨çš„è©±ï¼‰
        let finalTempo = sequence.tempo || 100;
        const tempoMatch = abcString.match(/Q:1\/4=(\d+)/);
        if (tempoMatch) {
          finalTempo = parseInt(tempoMatch[1]);
        }
        Tone.Transport.bpm.value = finalTempo;

        const sortedNotes = sequence.notes.sort(
          (a, b) =>
            Tone.Time(a.time).toSeconds() - Tone.Time(b.time).toSeconds()
        );

        currentPart = new Tone.Part((time, value) => {
          const normalizedVelocity = Math.min(
            Math.max(value.velocity || 0.7, 0.1),
            0.8
          );
          sampler.triggerAttackRelease(
            value.note,
            value.duration,
            time,
            normalizedVelocity
          );
          Tone.Draw.schedule(() => {
            const notesToHighlight = Array.isArray(value.note)
              ? value.note
              : [value.note];
            notesToHighlight.forEach((note) => {
              const keyElement = document.querySelector(
                `[data-note="${note}"]`
              );
              if (keyElement) {
                keyElement.classList.add("playing");
                setTimeout(
                  () => keyElement.classList.remove("playing"),
                  Tone.Time(value.duration).toMilliseconds()
                );
              }
            });
          }, time);
        }, sortedNotes).start(0);

        currentPart.loop = false;

        // è¨ˆç®—ç¸½æ’­æ”¾æ™‚é–“ä¸¦è¨­å®šè‡ªå‹•åœæ­¢
        const lastNote = sortedNotes[sortedNotes.length - 1];
        if (lastNote) {
          const endTime =
            Tone.Time(lastNote.time).toSeconds() +
            Tone.Time(lastNote.duration).toSeconds();
          // ä½¿ç”¨ schedule (è€Œä¸æ˜¯ scheduleOnce) ä»¥ä¾¿åœ¨æ¯æ¬¡é‡æ’­æ™‚éƒ½èƒ½è§¸ç™¼åœæ­¢
          // é€™å€‹æ’ç¨‹äº‹ä»¶æœƒåœ¨ setupPlayback é–‹å§‹æ™‚çš„ Tone.Transport.cancel() ä¸­è¢«æ¸…é™¤
          scheduledStopEvent = Tone.Transport.schedule(() => {
            Tone.Transport.stop();
          }, endTime + 0.1); // åŠ ä¸€é»ç·©è¡æ™‚é–“
        }

        playbackControls.classList.remove("hidden");
        sheetMusicContainer.classList.remove("hidden");

        // æ¸²æŸ“æ¨‚è­œ
        abcScorePreview.innerHTML = "";
        ABCJS.renderAbc(abcScorePreview, abcString, {
          responsive: "resize",
          staffwidth: 600,
          scale: 0.8,
          paddingright: 20,
          paddingleft: 20,
          paddingtop: 20,
          paddingbottom: 20,
          staffsep: 80,
          wrap: {
            minSpacing: 1.8,
            maxSpacing: 2.7,
            preferredMeasuresPerLine: 4,
          },
          format: {
            titlefont: "Times 16",
            gchordfont: "Times 12",
            annotationfont: "Times 12",
            vocalfont: "Times 12",
            wordsfont: "Times 12",
          },
        });

        downloadAbcBtn.onclick = () => {
          const blob = new Blob([abcString], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "ai-melody.abc";
          a.click();
          URL.revokeObjectURL(url);
        };
      }

      // --- çµ±ä¸€çš„äº‹ä»¶ç›£è½å™¨ ---
      playPauseBtn.addEventListener("click", async () => {
        if (Tone.context.state !== "running") {
          await Tone.context.resume();
        }
        if (Tone.Transport.state === "started") {
          Tone.Transport.pause();
        } else {
          Tone.Transport.start();
        }
      });

      stopBtn.addEventListener("click", () => {
        Tone.Transport.stop();
      });

      // ç›£è½ Transport ç‹€æ…‹è®ŠåŒ–ä¾†æ›´æ–°UI
      Tone.Transport.on("start", () => {
        playPauseBtn.textContent = "æš«åœ";
        console.log("Transport started, button set to 'æš«åœ'");
      });

      Tone.Transport.on("pause", () => {
        playPauseBtn.textContent = "ç¹¼çºŒ";
        console.log("Transport paused, button set to 'ç¹¼çºŒ'");
      });

      Tone.Transport.on("stop", () => {
        playPauseBtn.textContent = "æ’­æ”¾";
        Tone.Transport.position = 0;
        console.log("Transport stopped, button set to 'æ’­æ”¾'");
      });

      // --- ABC æª”æ¡ˆè¼‰å…¥åŠŸèƒ½ ---
      const abcFileInput = document.getElementById("abc-file-input");
      const loadAbcBtn = document.getElementById("load-abc-btn");
      const abcFileStatus = document.getElementById("abc-file-status");

      // å•Ÿç”¨è¼‰å…¥æŒ‰éˆ•ç•¶æª”æ¡ˆè¢«é¸æ“‡æ™‚
      abcFileInput.addEventListener("change", () => {
        if (abcFileInput.files.length > 0) {
          loadAbcBtn.disabled = false;
          loadAbcBtn.classList.remove("opacity-50", "cursor-not-allowed");
          abcFileStatus.textContent = `å·²é¸æ“‡æª”æ¡ˆ: ${abcFileInput.files[0].name}`;
          abcFileStatus.classList.remove("text-gray-600");
          abcFileStatus.classList.add("text-blue-600");
        } else {
          loadAbcBtn.disabled = true;
          loadAbcBtn.classList.add("opacity-50", "cursor-not-allowed");
          abcFileStatus.textContent = "è«‹é¸æ“‡ä¸€å€‹ .abc æª”æ¡ˆä¾†è¼‰å…¥æ¨‚è­œ";
          abcFileStatus.classList.remove("text-blue-600");
          abcFileStatus.classList.add("text-gray-600");
        }
      });

      // è§£æ ABC è¨˜è­œæ³•ä¸¦è½‰æ›ç‚ºéŸ³ç¬¦åºåˆ—
      function parseAbcToSequence(abcString) {
        try {
          console.log("é–‹å§‹è§£æ ABC æª”æ¡ˆ:", abcString);

          // æå–åŸºæœ¬è³‡è¨Š
          const tempoMatch = abcString.match(/Q:1\/4=(\d+)/);
          const tempo = tempoMatch ? parseInt(tempoMatch[1]) : 120;
          const meterMatch = abcString.match(/M:(\d+)\/(\d+)/);
          const meter = meterMatch
            ? { num: parseInt(meterMatch[1]), den: parseInt(meterMatch[2]) }
            : { num: 4, den: 4 };

          // æå–å–®ä½éŸ³ç¬¦é•·åº¦ (L: field)
          const lengthMatch = abcString.match(/L:1\/(\d+)/);
          const unitLength = lengthMatch ? parseInt(lengthMatch[1]) : 4; // é è¨­1/4
          const beatValue = 4 / unitLength; // æ¯å€‹å–®ä½éŸ³ç¬¦çš„æ‹æ•¸å€¼

          console.log(
            `è§£æåˆ° tempo: ${tempo}, meter: ${meter.num}/${meter.den}, unit length: 1/${unitLength} (${beatValue} æ‹)`
          );

          // åˆ†é›¢ä¸åŒè²éƒ¨
          const lines = abcString.split("\n");
          let voice1Lines = [];
          let voice2Lines = [];
          let currentVoice = null;

          lines.forEach((line) => {
            if (line.startsWith("[V:1]")) {
              currentVoice = 1;
              // æå–è²éƒ¨1çš„éŸ³ç¬¦å…§å®¹
              const content = line.substring(5).trim();
              if (content) voice1Lines.push(content);
            } else if (line.startsWith("[V:2")) {
              currentVoice = 2;
              // æå–è²éƒ¨2çš„éŸ³ç¬¦å…§å®¹
              const content = line.substring(line.indexOf("]") + 1).trim();
              if (content) voice2Lines.push(content);
            } else if (currentVoice === 1 && !line.match(/^[XTMLKQ]:/)) {
              if (line.trim()) voice1Lines.push(line.trim());
            } else if (currentVoice === 2 && !line.match(/^[XTMLKQ]:/)) {
              if (line.trim()) voice2Lines.push(line.trim());
            }
          });

          console.log("è²éƒ¨1å…§å®¹:", voice1Lines);
          console.log("è²éƒ¨2å…§å®¹:", voice2Lines);

          const notes = [];

          // è§£æè²éƒ¨1ï¼ˆå³æ‰‹/é«˜éŸ³ï¼‰
          if (voice1Lines.length > 0) {
            const voice1Notes = parseVoiceLine(
              voice1Lines.join(" "),
              1,
              meter,
              beatValue
            );
            notes.push(...voice1Notes);
          }

          // è§£æè²éƒ¨2ï¼ˆå·¦æ‰‹/ä½éŸ³ï¼‰
          if (voice2Lines.length > 0) {
            const voice2Notes = parseVoiceLine(
              voice2Lines.join(" "),
              2,
              meter,
              beatValue
            );
            notes.push(...voice2Notes);
          }

          console.log("è§£æå®Œæˆï¼Œå…±", notes.length, "å€‹éŸ³ç¬¦äº‹ä»¶");

          return {
            tempo: tempo,
            notes: notes,
          };
        } catch (error) {
          console.error("ABC è§£æéŒ¯èª¤:", error);
          return null;
        }
      }

      // è§£æå–®å€‹è²éƒ¨çš„éŸ³ç¬¦
      function parseVoiceLine(voiceLine, voiceNumber, meter, beatValue = 1) {
        const notes = [];
        let totalBeats = 0; // å…¨å±€æ™‚é–“è»¸

        // ç§»é™¤çµæŸç¬¦è™Ÿä¸¦æŒ‰å°ç¯€åˆ†å‰²
        const measures = voiceLine
          .replace(/\|]/g, "")
          .split("|")
          .filter((m) => m.trim());

        const measureLength = meter.num; // ä»¥æ‹æ•¸ç‚ºå–®ä½

        measures.forEach((measure, measureIndex) => {
          // è¿½è¹¤å°ç¯€å…§çš„æ‹æ•¸
          let measurePos = 0;
          console.log(
            `è™•ç†ç¬¬${
              measureIndex + 1
            }å°ç¯€ (è²éƒ¨${voiceNumber}): "${measure.trim()}"`
          );

          // åˆ†å‰²éŸ³ç¬¦/å’Œå¼¦ - æ”¹é€²æ­£å‰‡è¡¨é”å¼è™•ç†è¤‡é›œæ ¼å¼
          const tokens =
            measure
              .trim()
              .match(/\[[^\]]+\][\d\/]*|[A-Ga-g][#b,']*[\d\/]*|\S+/g) || [];

          tokens.forEach((token, idx) => {
            if (!token.trim()) return;

            // è¨ˆç®—åŸå§‹æ™‚å€¼
            let duration = parseDuration(token, beatValue);
            let cappedDuration = duration;

            // è‹¥è¶…éå°ç¯€å‰©é¤˜æ‹æ•¸ï¼Œå‰‡åªå–å‰©é¤˜æ‹æ•¸
            if (measurePos + duration > measureLength) {
              cappedDuration = measureLength - measurePos;
            }

            // è‹¥æ˜¯å…¨åˆ†éŸ³ç¬¦(æˆ–å”¯ä¸€éŸ³ç¬¦)ä¸”å‰›å¥½åœ¨å°ç¯€é–‹é ­ï¼Œç›´æ¥å»¶é•·åˆ°å°ç¯€çµæŸ
            if (
              measurePos === 0 &&
              (duration >= measureLength ||
                (tokens.length === 1 && duration >= measureLength * 0.8))
            ) {
              cappedDuration = measureLength;
              console.log(`å…¨åˆ†éŸ³ç¬¦è™•ç†: ${token} å»¶é•·åˆ° ${cappedDuration} æ‹`);
            }

            // æ§‹é€ éŸ³ç¬¦äº‹ä»¶
            const noteEvent = parseToken(
              token,
              totalBeats, // ä½¿ç”¨å…¨å±€æ™‚é–“
              voiceNumber,
              beatValue,
              meter,
              cappedDuration // å‚³éæ­£ç¢ºçš„æ™‚å€¼
            );
            if (noteEvent) {
              notes.push(noteEvent);
              console.log(`æ·»åŠ éŸ³ç¬¦äº‹ä»¶:`, noteEvent);
            }

            measurePos += cappedDuration;
            totalBeats += cappedDuration;
          });
        });

        return notes;
      }

      // è§£æå–®å€‹éŸ³ç¬¦/å’Œå¼¦token
      function parseToken(
        token,
        time,
        voiceNumber,
        beatValue = 1,
        meter = { num: 4, den: 4 },
        overrideDuration = null
      ) {
        // æª¢æŸ¥æ˜¯å¦ç‚ºå’Œå¼¦ [C,E,G,] æˆ– [CEG] æ ¼å¼
        const chordMatch = token.match(/\[([^\]]+)\]/);
        if (chordMatch) {
          const chordNotes = [];
          // åˆ†å‰²å’Œå¼¦å…§å®¹ï¼Œè™•ç†é€—è™Ÿåˆ†éš”å’Œé€£çºŒéŸ³ç¬¦æ ¼å¼
          const chordContent = chordMatch[1];
          let noteStrings = [];

          // æª¢æŸ¥æ˜¯å¦ç‚ºé€—è™Ÿåˆ†éš”æ ¼å¼ (å¦‚ "C,G,C") æˆ–æ··åˆæ ¼å¼ (å¦‚ "G,B,D F")
          if (chordContent.includes(",")) {
            // å…ˆæŒ‰ç©ºæ ¼åˆ†å‰²ï¼Œå†è™•ç†æ¯å€‹éƒ¨åˆ†çš„é€—è™Ÿ
            const spaceParts = chordContent.split(/\s+/);
            noteStrings = [];

            for (const spacePart of spaceParts) {
              if (spacePart.includes(",")) {
                // è™•ç†é€—è™Ÿåˆ†éš”çš„éƒ¨åˆ† (å¦‚ "G,B,D")
                const commaParts = spacePart.split(",");
                for (let i = 0; i < commaParts.length; i++) {
                  const part = commaParts[i].trim();
                  if (!part) continue;

                  if (i < commaParts.length - 1) {
                    // ä¸æ˜¯æœ€å¾Œä¸€å€‹éƒ¨åˆ†ï¼Œæ·»åŠ é€—è™Ÿè¡¨ç¤ºä½å…«åº¦
                    noteStrings.push(part + ",");
                  } else {
                    // æœ€å¾Œä¸€å€‹éƒ¨åˆ†ï¼Œä¿æŒåŸæ¨£
                    noteStrings.push(part);
                  }
                }
              } else {
                // æ²’æœ‰é€—è™Ÿçš„éƒ¨åˆ†ï¼Œç›´æ¥æ·»åŠ 
                noteStrings.push(spacePart.trim());
              }
            }
          } else {
            // è™•ç†ç©ºæ ¼åˆ†éš”çš„éŸ³ç¬¦æ ¼å¼ (å¦‚ "c e g c'") å’Œé€£çºŒéŸ³ç¬¦æ ¼å¼ (å¦‚ "CEG")
            if (chordContent.includes(" ")) {
              // ç©ºæ ¼åˆ†éš”çš„éŸ³ç¬¦
              noteStrings = chordContent.split(/\s+/).filter((n) => n.trim());
            } else {
              // é€£çºŒéŸ³ç¬¦æ ¼å¼ï¼Œä½¿ç”¨æ­£å‰‡è¡¨é”å¼åˆ†å‰²
              noteStrings = chordContent.match(/[A-Ga-g][#b]?[',]*/g) || [];
            }
          }

          console.log(`è§£æå’Œå¼¦ ${token}:`, noteStrings);
          console.log(`å’Œå¼¦å…§å®¹: "${chordContent}"`);

          for (const noteStr of noteStrings) {
            const note = convertAbcToToneJs(noteStr.trim(), voiceNumber);
            if (note) {
              chordNotes.push(note);
              console.log(`å’Œå¼¦éŸ³ç¬¦: ${noteStr} -> ${note}`);
            } else {
              console.warn(`ç„¡æ³•è½‰æ›éŸ³ç¬¦: ${noteStr}`);
            }
          }

          if (chordNotes.length > 0) {
            return {
              time: `${time}*${beatValue}`,
              note: chordNotes,
              duration: getDurationString(
                overrideDuration !== null
                  ? overrideDuration
                  : parseDuration(token, beatValue)
              ),
              velocity: 0.6,
            };
          }
        } else {
          // å–®å€‹éŸ³ç¬¦
          const note = convertAbcToToneJs(token, voiceNumber);
          if (note) {
            return {
              time: `${time}*${beatValue}`,
              note: note,
              duration: getDurationString(
                overrideDuration !== null
                  ? overrideDuration
                  : parseDuration(token, beatValue)
              ),
              velocity: 0.6,
            };
          }
        }

        return null;
      }

      // è§£æéŸ³ç¬¦æŒçºŒæ™‚é–“
      function parseDuration(token, beatValue = 1) {
        // ç§»é™¤å’Œå¼¦æ‹¬è™Ÿä¾†æª¢æŸ¥æŒçºŒæ™‚é–“
        const cleanToken = token.replace(/[\[\]]/g, "");

        // æª¢æŸ¥åˆ†æ•¸è¨˜è™Ÿ (å¦‚ C/2, G/4)
        const fractionMatch = cleanToken.match(/\/(\d+)/);
        if (fractionMatch) {
          return (1 / parseFloat(fractionMatch[1])) * beatValue;
        }

        // æª¢æŸ¥æ•¸å­—å¾Œç¶´ (å¦‚ G2, C4)
        const durationMatch = cleanToken.match(/(\d+)$/);
        if (durationMatch) {
          return parseFloat(durationMatch[1]) * beatValue;
        }

        // é è¨­å–®ä½é•·åº¦
        return beatValue;
      }

      // å°‡æ•¸å­—æŒçºŒæ™‚é–“è½‰æ›ç‚º Tone.js å­—ä¸²æ ¼å¼
      function getDurationString(beats) {
        // æ”¯æ´è¶…é4æ‹çš„è‡ªè¨‚æ™‚å€¼ï¼ˆå¦‚6/4ã€3/2ç­‰ï¼‰
        if (beats >= 4) return "1n"; // å…¨éŸ³ç¬¦åŠä»¥ä¸Šéƒ½ç”¨å…¨éŸ³ç¬¦
        if (beats >= 3) return "2n."; // é™„é»äºŒåˆ†éŸ³ç¬¦
        if (beats >= 2) return "2n"; // äºŒåˆ†éŸ³ç¬¦
        if (beats >= 1.5) return "4n."; // é™„é»å››åˆ†éŸ³ç¬¦
        if (beats >= 1) return "4n"; // å››åˆ†éŸ³ç¬¦
        if (beats >= 0.75) return "8n."; // é™„é»å…«åˆ†éŸ³ç¬¦
        if (beats >= 0.5) return "8n"; // å…«åˆ†éŸ³ç¬¦
        return "16n"; // åå…­åˆ†éŸ³ç¬¦
      }

      // å°‡ ABC è¨˜è­œæ³•çš„éŸ³ç¬¦è½‰æ›ç‚º Tone.js æ ¼å¼
      function convertAbcToToneJs(abcNote, voiceNumber = 1) {
        if (!abcNote || abcNote.trim() === "") return null;

        // å…ˆç§»é™¤æ™‚é•·æ¨™è¨˜ï¼Œä¾‹å¦‚ "C4" -> "C", "g/2" -> "g"
        const noteOnly = abcNote.replace(/[\d/]+$/, "");

        // ç§»é™¤ééŸ³ç¬¦å­—ç¬¦ï¼Œä½†ä¿ç•™å¤§å°å¯«ä¿¡æ¯
        const cleanNote = noteOnly.replace(/[^\w#b',]/g, "");
        if (!cleanNote) return null;

        // åŸºæœ¬éŸ³ç¬¦æ˜ å°„
        let note = cleanNote.charAt(0);
        let accidental = "";
        let octave;

        // ABC è¨˜è­œæ³•ï¼šå¤§å¯«å­—æ¯ç‚ºä½å…«åº¦ï¼Œå°å¯«å­—æ¯ç‚ºé«˜å…«åº¦
        if (note >= "A" && note <= "G") {
          // å¤§å¯«å­—æ¯ (ä½å…«åº¦)
          note = note.toUpperCase();
          octave = voiceNumber === 1 ? 4 : 3; // è²éƒ¨1é è¨­4ï¼Œè²éƒ¨2é è¨­3
        } else if (note >= "a" && note <= "g") {
          // å°å¯«å­—æ¯ (é«˜å…«åº¦)
          note = note.toUpperCase();
          octave = voiceNumber === 1 ? 5 : 4; // å°å¯«å­—æ¯æ¯”å¤§å¯«é«˜ä¸€å€‹å…«åº¦
        } else {
          return null;
        }

        // è™•ç†å‡é™è™Ÿ
        if (cleanNote.includes("#")) accidental = "#";
        if (cleanNote.includes("b")) accidental = "b";

        // è™•ç†å…«åº¦æ¨™è¨˜
        const commaCount = (cleanNote.match(/,/g) || []).length;
        const apostropheCount = (cleanNote.match(/'/g) || []).length;

        // ABCè¨˜è­œæ³•ä¸­ï¼Œé€—è™Ÿé™å…«åº¦ï¼Œæ’‡è™Ÿå‡å…«åº¦
        octave = octave - commaCount + apostropheCount;

        // ç¢ºä¿å…«åº¦åœ¨åˆç†ç¯„åœå…§
        octave = Math.max(0, Math.min(8, octave));

        const result = `${note}${accidental}${octave}`;
        console.log(
          `è½‰æ›éŸ³ç¬¦: ${abcNote} -> ${result} (è²éƒ¨${voiceNumber}, é€—è™Ÿ:${commaCount}, æ’‡è™Ÿ:${apostropheCount})`
        );
        return result;
      }

      // è¼‰å…¥ ABC æª”æ¡ˆåŠŸèƒ½
      loadAbcBtn.addEventListener("click", async () => {
        const file = abcFileInput.files[0];
        if (!file) {
          alert("è«‹å…ˆé¸æ“‡ä¸€å€‹æª”æ¡ˆï¼");
          return;
        }

        try {
          abcFileStatus.textContent = "æ­£åœ¨è¼‰å…¥æª”æ¡ˆ...";
          abcFileStatus.classList.remove(
            "text-blue-600",
            "text-green-600",
            "text-red-600"
          );
          abcFileStatus.classList.add("text-orange-600");

          const fileContent = await file.text();
          console.log("è¼‰å…¥çš„ ABC å…§å®¹:", fileContent);

          // è§£æ ABC æª”æ¡ˆ
          const sequence = parseAbcToSequence(fileContent);

          if (!sequence || !sequence.notes || sequence.notes.length === 0) {
            throw new Error("ç„¡æ³•è§£æ ABC æª”æ¡ˆæˆ–æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„éŸ³ç¬¦");
          }

          // é¡¯ç¤ºè§£æçµæœçš„è©³ç´°ä¿¡æ¯
          console.log("è§£æçµæœæ‘˜è¦:");
          console.log("- ç¸½éŸ³ç¬¦æ•¸:", sequence.notes.length);
          console.log("- Tempo:", sequence.tempo);
          console.log("- å‰5å€‹éŸ³ç¬¦:", sequence.notes.slice(0, 5));

          // æª¢æŸ¥éŸ³ç¬¦çš„æ™‚é–“åˆ†ä½ˆ
          const timings = sequence.notes.map((n) => n.time).sort();
          console.log(
            "- æ™‚é–“ç¯„åœ:",
            timings[0],
            "åˆ°",
            timings[timings.length - 1]
          );

          // è¨­å®šæ’­æ”¾åŠŸèƒ½
          setupPlayback(sequence, fileContent);

          // æ›´æ–°çµæœé¡¯ç¤º
          resultText.innerHTML = `<strong>å·²è¼‰å…¥ ABC æª”æ¡ˆï¼š</strong>${file.name}<br><strong>éŸ³ç¬¦æ•¸é‡ï¼š</strong>${sequence.notes.length}<br><strong>é€Ÿåº¦ï¼š</strong>${sequence.tempo} BPM`;

          abcFileStatus.textContent = `âœ“ æˆåŠŸè¼‰å…¥æª”æ¡ˆ: ${file.name}`;
          abcFileStatus.classList.remove("text-orange-600");
          abcFileStatus.classList.add("text-green-600");
        } catch (error) {
          console.error("è¼‰å…¥ ABC æª”æ¡ˆå¤±æ•—:", error);
          abcFileStatus.textContent = `âœ— è¼‰å…¥å¤±æ•—: ${error.message}`;
          abcFileStatus.classList.remove("text-orange-600");
          abcFileStatus.classList.add("text-red-600");

          resultText.textContent = `è¼‰å…¥ ABC æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`;
        }
      });

      // --- Gemini API åŠŸèƒ½ ---
      const generateBtn = document.getElementById("generate-btn");
      const promptInput = document.getElementById("prompt-input");
      const resultText = document.getElementById("result-text");
      const loader = document.getElementById("loader");
      const apiKeyInput = document.getElementById("api-key-input");
      const saveKeyBtn = document.getElementById("save-key-btn");
      const clearKeyBtn = document.getElementById("clear-key-btn");
      const apiKeySetupView = document.getElementById("api-key-setup-view");
      const apiKeyDisplayView = document.getElementById("api-key-display-view");

      function checkApiKey() {
        const apiKey = localStorage.getItem("geminiApiKey");
        if (apiKey) {
          apiKeySetupView.classList.add("hidden");
          apiKeyDisplayView.classList.remove("hidden");
          // æª¢æŸ¥è¼¸å…¥æ¡†æ˜¯å¦æœ‰å…§å®¹æ‰å•Ÿç”¨æŒ‰éˆ•
          updateGenerateButtonState();
        } else {
          apiKeySetupView.classList.remove("hidden");
          apiKeyDisplayView.classList.add("hidden");
          generateBtn.disabled = true;
          generateBtn.classList.add("opacity-50", "cursor-not-allowed");
          resultText.textContent =
            "è«‹å…ˆåœ¨ä¸Šæ–¹è¨­å®šæ‚¨çš„ Gemini API é‡‘é‘°ä»¥å•Ÿç”¨æ­¤åŠŸèƒ½ã€‚";
        }
      }

      function updateGenerateButtonState() {
        const apiKey = localStorage.getItem("geminiApiKey");
        const hasPrompt = promptInput.value.trim().length > 0;

        if (apiKey && hasPrompt) {
          generateBtn.disabled = false;
          generateBtn.classList.remove("opacity-50", "cursor-not-allowed");
        } else {
          generateBtn.disabled = true;
          generateBtn.classList.add("opacity-50", "cursor-not-allowed");
        }
      }

      saveKeyBtn.addEventListener("click", () => {
        const apiKey = apiKeyInput.value.trim();
        if (apiKey) {
          localStorage.setItem("geminiApiKey", apiKey);
          alert("API é‡‘é‘°å·²å„²å­˜ï¼");
          checkApiKey();
          resultText.textContent = "å·²è¼‰å…¥æ‚¨çš„ API é‡‘é‘°ï¼Œå¯ä»¥é–‹å§‹ç”¢ç”Ÿéˆæ„Ÿäº†ï¼";
        } else {
          alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ API é‡‘é‘°ã€‚");
        }
      });

      clearKeyBtn.addEventListener("click", () => {
        localStorage.removeItem("geminiApiKey");
        alert("API é‡‘é‘°å·²æ¸…é™¤ï¼");
        checkApiKey();
      });

      promptInput.addEventListener("input", () => {
        playbackControls.classList.add("hidden");
        sheetMusicContainer.classList.add("hidden");
        Tone.Transport.stop();

        updateGenerateButtonState();
      });

      async function handleGenerateClick() {
        const apiKey = localStorage.getItem("geminiApiKey");
        if (!apiKey) {
          alert("è«‹å…ˆå„²å­˜æ‚¨çš„ Gemini API é‡‘é‘°ï¼");
          return;
        }
        const userPrompt = promptInput.value.trim();
        if (!userPrompt) {
          resultText.textContent = "è«‹å…ˆè¼¸å…¥ä¸€å€‹ä¸»é¡Œæˆ–æƒ…å¢ƒï¼";
          return;
        }

        resultText.textContent = "";
        loader.classList.remove("hidden");
        generateBtn.disabled = true;
        generateBtn.classList.add("opacity-50", "cursor-not-allowed");
        playbackControls.classList.add("hidden");
        sheetMusicContainer.classList.add("hidden");

        // ä¿®æ­£ï¼šå¼·åŒ– ABC è­œçš„ promptï¼Œè¦æ±‚åŒ…å«æ­£ç¢ºçš„é‹¼ç´è­œæ ¼å¼
        const fullPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šæ¨‚ç†çš„AIä½œæ›²å®¶ã€‚æ ¹æ“šä»¥ä¸‹ä¸»é¡Œï¼Œå‰µä½œä¸€æ®µ8åˆ°16å°ç¯€ï¼Œé©åˆé‹¼ç´ç¨å¥çš„ç°¡çŸ­éŸ³æ¨‚ã€‚è«‹åŒ…å«æ—‹å¾‹å’Œå’Œå¼¦ä¼´å¥ã€‚è«‹ä»¥JSONæ ¼å¼å›å‚³ï¼ŒåŒ…å«ï¼š

1. 'tempo' (BPMé€Ÿåº¦ï¼Œå»ºè­°60-120)
2. 'melody_description' (æ—‹å¾‹æè¿°æ–‡å­—)
3. 'notes' (éŸ³ç¬¦ç‰©ä»¶é™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶åŒ…å« 'time', 'note' (å¯ä»¥æ˜¯å­—ä¸²æˆ–å­—ä¸²é™£åˆ—ï¼Œé™£åˆ—è¡¨ç¤ºå’Œå¼¦), 'duration', 'velocity' (0.1-0.8ä¹‹é–“))
4. 'abc_notation' (æ¨™æº–ABCè­œæ ¼å¼çš„å­—ä¸²ï¼Œå¿…é ˆåŒ…å«å®Œæ•´æ¨™é ­ä¸¦ä½¿ç”¨æ­£ç¢ºçš„é‹¼ç´è­œæ ¼å¼)

ABCè¨˜è­œæ³•è¦æ±‚ï¼š
- æ¨™é ­æ ¼å¼ï¼šX:1\\nT:${userPrompt}\\nM:4/4\\nL:1/4\\nK:C\\nQ:1/4=[tempo]
- ä½¿ç”¨é›™äº”ç·šè­œæ ¼å¼ï¼Œå³æ‰‹é«˜éŸ³è­œè¨˜è™Ÿï¼Œå·¦æ‰‹ä½éŸ³è­œè¨˜è™Ÿ
- å³æ‰‹éƒ¨åˆ†ï¼ˆé«˜éŸ³è­œè¨˜è™Ÿï¼‰ï¼š[V:1] éŸ³åŸŸå»ºè­°åœ¨C-c'ä¹‹é–“ï¼ˆC4-C6ï¼‰
- å·¦æ‰‹éƒ¨åˆ†ï¼ˆä½éŸ³è­œè¨˜è™Ÿï¼‰ï¼š[V:2 clef=bass] éŸ³åŸŸå»ºè­°åœ¨C,-Cä¹‹é–“ï¼ˆC2-C4ï¼‰
- å’Œå¼¦è¡¨ç¤ºæ³•ï¼šå³æ‰‹ç”¨[CEG]ï¼Œå·¦æ‰‹ç”¨[C,E,G,]ï¼ˆé€—è™Ÿè¡¨ç¤ºä½å…«åº¦ï¼‰
- å°ç¯€ç·šç”¨ | åˆ†éš”ï¼Œæ¨‚æ›²çµæŸå¿…é ˆç”¨ |] ï¼ˆé›™ç·šè¡¨ç¤ºçµæŸï¼‰
- ç¢ºä¿æ¯å€‹è²éƒ¨éƒ½æœ‰çµæŸæ¨™è¨˜
- ç¯„ä¾‹æ ¼å¼ï¼š
  [V:1] C E G c | F A c f | G E C2 |]
  [V:2 clef=bass] C, E, G, C | F, A, C F | C, G, C,2 |]

è«‹ç¢ºä¿å’Œå¼¦ç¬¦åˆäººé¡å½ˆå¥èƒ½åŠ›ï¼š
- å’Œå¼¦æœ€å¤šåŒ…å«3-4å€‹éŸ³ç¬¦
- éŸ³ç¬¦ä¹‹é–“çš„è·¨åº¦ä¸è¶…éä¸€å€‹å…«åº¦ï¼ˆ12å€‹åŠéŸ³ï¼‰
- å·¦æ‰‹å’Œå¼¦å»ºè­°åœ¨C2-C4ç¯„åœå…§
- å³æ‰‹æ—‹å¾‹å»ºè­°åœ¨C4-C6ç¯„åœå…§
- notes é™£åˆ—ä¸­çš„å’Œå¼¦å¿…é ˆç”¨å­—ä¸²é™£åˆ—è¡¨ç¤ºï¼Œå¦‚ ["C3", "E3", "G3"] è¡¨ç¤ºCå¤§èª¿å’Œå¼¦
- å–®éŸ³ç”¨å­—ä¸²è¡¨ç¤ºï¼Œå¦‚ "C4"
- velocity å€¼åœ¨ 0.1 åˆ° 0.8 ä¹‹é–“
- ä½¿ç”¨å¸¸è¦‹çš„å’Œå¼¦é€²è¡Œï¼Œå¦‚ C-Am-F-G æˆ– C-F-G-C
- ç¢ºä¿tempoæ¨™è¨˜æ­£ç¢ºï¼šQ:1/4=[å¯¦éš›BPMæ•¸å€¼]
- æ¯å€‹è²éƒ¨éƒ½å¿…é ˆä»¥ |] çµæŸï¼Œè¡¨ç¤ºæ¨‚æ›²çµæŸ
- ç¢ºä¿notesé™£åˆ—åŒ…å«å·¦å³æ‰‹çš„éŸ³ç¬¦ï¼Œå·¦æ‰‹ç”¨å’Œå¼¦ä¼´å¥ï¼Œå³æ‰‹ç”¨æ—‹å¾‹æˆ–å’Œå¼¦

ä¸»é¡Œæ˜¯ï¼š${userPrompt}`;

        try {
          const payload = {
            contents: [{ role: "user", parts: [{ text: fullPrompt }] }],
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  tempo: { type: "NUMBER" },
                  melody_description: { type: "STRING" },
                  notes: {
                    type: "ARRAY",
                    items: {
                      type: "OBJECT",
                      properties: {
                        time: { type: "STRING" },
                        note: {
                          oneOf: [
                            { type: "STRING" },
                            { type: "ARRAY", items: { type: "STRING" } },
                          ],
                        },
                        duration: { type: "STRING" },
                        velocity: {
                          type: "NUMBER",
                          minimum: 0.1,
                          maximum: 0.8,
                        },
                      },
                      required: ["time", "note", "duration", "velocity"],
                    },
                  },
                  abc_notation: { type: "STRING" },
                },
                required: [
                  "tempo",
                  "melody_description",
                  "notes",
                  "abc_notation",
                ],
              },
            },
          };
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            let errorDetails = `API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}`;
            try {
              const errorBody = await response.json();
              if (errorBody.error && errorBody.error.message) {
                errorDetails += ` - ${errorBody.error.message}`;
              }
            } catch (e) {}
            throw new Error(errorDetails);
          }
          const result = await response.json();
          console.log("Gemini API Response:", result);
          const data = JSON.parse(result.candidates[0].content.parts[0].text);

          resultText.innerHTML = `<strong>æ—‹å¾‹æè¿°ï¼š</strong>${data.melody_description}`;

          // ç›´æ¥ä½¿ç”¨ABCè§£æå™¨ä¾†ç¢ºä¿ä¸€è‡´çš„æ ¼å¼
          const sequence = parseAbcToSequence(data.abc_notation);
          if (sequence) {
            setupPlayback(sequence, data.abc_notation);
          } else {
            // å¦‚æœABCè§£æå¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨åŸå§‹æ•¸æ“šä½†æœƒè§¸ç™¼é‡æ–°è§£æ
            console.log("ABCè§£æå¤±æ•—ï¼Œä½¿ç”¨åŸå§‹æ•¸æ“šä¸¦å°‡è§¸ç™¼é‡æ–°è§£æ");
            setupPlayback(data, data.abc_notation);
          }
        } catch (error) {
          console.error("Gemini API å‘¼å«å¤±æ•—:", error);
          resultText.textContent = `ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}ã€‚`;
        } finally {
          loader.classList.add("hidden");
          checkApiKey();
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        generateBtn.onclick = handleGenerateClick;
        const apiKey = localStorage.getItem("geminiApiKey");
        if (apiKey) {
          apiKeySetupView.classList.add("hidden");
          apiKeyDisplayView.classList.remove("hidden");
        } else {
          apiKeySetupView.classList.remove("hidden");
          apiKeyDisplayView.classList.add("hidden");
        }
        checkApiKey();
      });

      // é é¢è¼‰å…¥æ™‚æª¢æŸ¥APIé‡‘é‘°ç‹€æ…‹
      checkApiKey();
    </script>
  </body>
</html>
